<!DOCTYPE html>
<html lang="en" dir="ltr" id="appHtml" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="theme-color" content="#ddd0a8">
<title>ALTANTAWY Comparison Tool ‚Äî Al Safwah Tower 3</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f2f4f8; --bg2: #e8eaf0; --surface: rgba(255,255,255,0.85); --surface2: rgba(245,247,252,0.70);
    --border: rgba(160,170,200,0.30); --border2: rgba(160,170,200,0.15);
    --accent: #3a3f5c; --accent-mid: #5a6080; --accent-light: #8890b0; --accent-glow: rgba(90,96,128,0.12);
    --teal: #1a7a7a; --teal-light: #2a9d9d; --green: #1a6b3a; --red: #9b2020; --yellow: #7a6010; --purple: #5a1a7a;
    --text: #1a1d2e; --text2: #3a3f5c; --muted: #7a80a0; --muted2: #a0a8c0;
    --shadow: 0 4px 20px rgba(60,70,120,0.10),0 1px 4px rgba(40,50,100,0.07);
    --shadow-hover: 0 8px 32px rgba(60,70,120,0.16),0 2px 8px rgba(40,50,100,0.10);
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  *,*::before,*::after{transition:background-color .25s ease,border-color .25s ease,color .20s ease,box-shadow .20s ease;}
  body{background-color:#0d1b3e;background-image:radial-gradient(ellipse at 50% 0%,rgba(0,200,255,0.18) 0%,transparent 60%),radial-gradient(ellipse at 0% 60%,rgba(0,120,255,0.14) 0%,transparent 50%),radial-gradient(ellipse at 100% 40%,rgba(80,0,200,0.12) 0%,transparent 50%),radial-gradient(ellipse at 50% 100%,rgba(0,60,180,0.20) 0%,transparent 55%),linear-gradient(160deg,#07090f 0%,#0a0f1e 40%,#080c1a 70%,#06090f 100%);background-size:cover;color:var(--text);font-family:'IBM Plex Sans',sans-serif;min-height:100vh;padding:20px;}
  header{text-align:center;margin-bottom:16px;padding:20px 24px 16px;position:relative;background:linear-gradient(135deg,rgba(255,255,255,0.95) 0%,rgba(245,247,255,0.92) 100%);border-radius:16px;border:1px solid rgba(160,170,200,0.35);border-top:3px solid #5a6080;box-shadow:var(--shadow);}
  h1{font-size:1.6rem;font-weight:700;color:var(--accent);letter-spacing:-0.3px;}
  h1 span{color:var(--teal);}
  .subtitle{color:var(--muted);font-size:0.78rem;margin-top:4px;font-family:'IBM Plex Mono',monospace;letter-spacing:1.2px;text-transform:uppercase;}
  .top-actions{display:flex;justify-content:flex-end;gap:10px;margin-bottom:16px;}
  .btn-clear{background:rgba(245,247,252,0.85);border:1px solid rgba(155,32,32,0.40);color:var(--red);border-radius:8px;padding:7px 16px;font-size:0.8rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s;box-shadow:0 1px 4px rgba(0,0,0,0.06);}
  .btn-clear:hover{background:rgba(155,32,32,0.08);}
  .upload-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;}
  @media(max-width:700px){.upload-grid{grid-template-columns:1fr;}}
  .upload-card{background:linear-gradient(145deg,rgba(255,255,255,0.92) 0%,rgba(245,247,255,0.88) 100%);border:1px solid rgba(160,170,200,0.35);border-top:2px solid rgba(130,140,180,0.55);border-radius:14px;padding:18px 20px;box-shadow:var(--shadow);transition:box-shadow .2s;}
  .upload-card:hover{box-shadow:var(--shadow-hover);}
  .card-label{font-size:0.68rem;font-family:'IBM Plex Mono',monospace;color:var(--teal);text-transform:uppercase;letter-spacing:1.4px;margin-bottom:5px;font-weight:600;}
  .card-title{font-size:0.92rem;font-weight:700;color:var(--accent);margin-bottom:10px;}
  .file-slots{display:flex;flex-direction:column;gap:6px;}
  .file-slot{background:rgba(245,247,252,0.70);border:1.5px dashed rgba(130,140,180,0.40);border-radius:8px;padding:8px 11px;display:flex;align-items:center;gap:9px;transition:all .2s;cursor:pointer;}
  .file-slot:hover,.file-slot.dragover{border-color:var(--accent-mid);background:var(--accent-glow);}
  .file-slot input[type="file"]{display:none;}
  .slot-icon{font-size:1.1rem;flex-shrink:0;}
  .slot-info{flex:1;min-width:0;}
  .slot-label{font-size:0.72rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;}
  .slot-name{font-size:0.75rem;color:var(--accent);font-family:'IBM Plex Mono',monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px;display:none;}
  .slot-name.visible{display:block;}
  .remove-slot{background:transparent;border:none;color:var(--muted2);cursor:pointer;font-size:.9rem;padding:2px 4px;border-radius:4px;transition:color .2s;flex-shrink:0;}
  .remove-slot:hover{color:var(--red);}
  .add-file-btn{background:rgba(245,247,252,0.60);border:1px dashed rgba(130,140,180,0.40);color:var(--muted);border-radius:7px;padding:6px 10px;font-size:0.74rem;cursor:pointer;transition:all .2s;margin-top:5px;font-family:inherit;display:flex;align-items:center;gap:5px;}
  .add-file-btn:hover{border-color:var(--accent-mid);color:var(--accent);background:var(--accent-glow);}
  .paste-lbl{font-size:0.68rem;color:var(--muted);margin:8px 0 4px;}
  textarea.paste-box{width:100%;height:60px;background:rgba(255,248,220,0.65);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:7px 9px;font-size:0.73rem;font-family:'IBM Plex Mono',monospace;resize:vertical;outline:none;transition:all .2s;}
  textarea.paste-box:focus{border-color:var(--accent-mid);box-shadow:0 0 0 3px var(--accent-glow);}
  textarea.paste-box::placeholder{color:var(--muted2);}
  .compare-btn{display:block;width:100%;padding:13px;background:linear-gradient(135deg,#8890b0 0%,#5a6080 50%,#3a3f5c 100%);color:#fff;border:none;border-radius:10px;font-size:0.95rem;font-weight:700;cursor:pointer;letter-spacing:.6px;transition:all .2s;font-family:inherit;margin-bottom:18px;box-shadow:0 4px 18px rgba(60,70,120,0.30),0 1px 4px rgba(0,0,0,0.12);text-shadow:0 1px 3px rgba(0,0,0,0.20);}
  .compare-btn:hover{background:linear-gradient(135deg,#a0a8c8 0%,#6a7090 50%,#4a5070 100%);transform:translateY(-1px);box-shadow:0 7px 28px rgba(60,70,120,0.40);}
  .stats{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:14px;}
  @media(max-width:580px){.stats{grid-template-columns:repeat(3,1fr);}}
  .stat{background:linear-gradient(145deg,rgba(255,255,255,0.92),rgba(245,247,255,0.88));border:1px solid rgba(160,170,200,0.30);border-radius:10px;padding:8px 10px;text-align:center;cursor:pointer;transition:all .2s;user-select:none;box-shadow:var(--shadow);}
  .stat:hover{box-shadow:var(--shadow-hover);transform:translateY(-2px);}
  .stat.active-stat{border-color:var(--accent-mid);box-shadow:0 0 0 2px var(--accent-glow),var(--shadow);}
  .s-match.active-stat{border-color:var(--green);box-shadow:0 0 0 2px rgba(26,107,58,0.15);}
  .s-diff.active-stat{border-color:var(--yellow);box-shadow:0 0 0 2px rgba(154,112,32,0.18);}
  .s-nohotel.active-stat{border-color:var(--red);box-shadow:0 0 0 2px rgba(155,32,32,0.15);}
  .s-nosys.active-stat{border-color:var(--teal);box-shadow:0 0 0 2px rgba(26,122,122,0.15);}
  .stat .num{font-size:1.45rem;font-weight:700;font-family:'IBM Plex Mono',monospace;}
  .stat .lbl{font-size:0.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;margin-top:2px;}
  .s-total .num{color:var(--accent);}
  .s-match .num{color:var(--green);}
  .s-diff .num{color:var(--yellow);}
  .s-nohotel .num{color:var(--red);}
  .s-nosys .num{color:var(--teal);}
  .search-box{width:100%;background:rgba(255,255,255,0.82);border:1px solid rgba(160,170,200,0.30);border-radius:8px;padding:8px 12px;color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:0.81rem;margin-bottom:11px;outline:none;transition:all .2s;box-shadow:0 1px 4px rgba(60,70,120,0.06);}
  .search-box:focus{border-color:var(--accent-mid);box-shadow:0 0 0 3px var(--accent-glow);}
  .search-box::placeholder{color:var(--muted2);}
  .search-count{font-size:0.72rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-bottom:8px;display:none;}
  .search-count.visible{display:block;}
  .section-hdr{display:flex;align-items:center;gap:9px;margin:16px 0 8px;padding-bottom:7px;border-bottom:1px solid rgba(160,170,200,0.28);}
  .section-hdr h3{font-size:0.78rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;}
  .sdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
  .sd-match{background:var(--green);}
  .sd-diff{background:var(--yellow);}
  .sd-nohotel{background:var(--red);}
  .sd-nosys{background:var(--teal);}
  .sd-warn{background:#ff9800;}
  .result-item{background:linear-gradient(145deg,rgba(255,255,255,0.90),rgba(245,247,255,0.85));border:1px solid rgba(160,170,200,0.30);border-radius:10px;margin-bottom:6px;overflow:hidden;transition:all .2s;box-shadow:0 2px 10px rgba(60,70,120,0.07);}
  .result-item:hover{box-shadow:var(--shadow-hover);}
  .st-match{border-left:3px solid var(--green);}
  .st-diff{border-left:3px solid var(--yellow);}
  .st-nohotel{border-left:3px solid var(--red);}
  .st-nosys{border-left:3px solid var(--teal);}
  .result-header{display:flex;align-items:center;gap:9px;padding:9px 13px;cursor:pointer;user-select:none;}
  .rsv-num{font-family:'IBM Plex Mono',monospace;font-weight:600;font-size:0.85rem;color:var(--accent);min-width:76px;}
  .rsv-copy-btn{background:transparent;border:1px solid rgba(160,170,200,0.35);border-radius:5px;color:var(--muted);cursor:pointer;font-size:0.72rem;padding:2px 6px;line-height:1;transition:all .18s;flex-shrink:0;font-family:'IBM Plex Mono',monospace;display:inline-flex;align-items:center;gap:3px;}
  .rsv-copy-btn:hover{color:var(--accent);border-color:var(--accent-mid);background:var(--accent-glow);}
  .rsv-copy-btn.copied{color:var(--green);border-color:var(--green);background:rgba(26,107,58,0.08);}
  .guest-name{flex:1;font-size:0.83rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .htl-tag{font-size:0.65rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;white-space:nowrap;flex-shrink:0;}
  .badge{font-size:0.65rem;font-weight:700;padding:3px 8px;border-radius:9px;white-space:nowrap;font-family:'IBM Plex Mono',monospace;text-transform:uppercase;letter-spacing:.4px;flex-shrink:0;}
  .bd-match{background:rgba(26,107,58,.12);color:var(--green);border:1px solid rgba(26,107,58,.25);}
  .bd-diff{background:rgba(154,112,32,.12);color:var(--yellow);border:1px solid rgba(154,112,32,.25);}
  .bd-nohotel{background:rgba(155,32,32,.12);color:var(--red);border:1px solid rgba(155,32,32,.25);}
  .bd-nosys{background:rgba(26,122,122,.12);color:var(--teal);border:1px solid rgba(26,122,122,.25);}
  .chevron{color:var(--muted);transition:transform .2s;font-size:0.72rem;flex-shrink:0;}
  .result-item.open .chevron{transform:rotate(180deg);}
  .result-body{padding:0 13px 11px;border-top:1px solid rgba(160,170,200,0.18);display:none;background:rgba(245,247,255,0.40);}
  .result-item.open .result-body{display:block;}
  table.ctbl{width:100%;border-collapse:collapse;margin-top:9px;font-size:0.78rem;}
  .ctbl th{text-align:left;color:var(--muted);font-weight:500;padding:5px 9px;font-family:'IBM Plex Mono',monospace;font-size:0.69rem;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid rgba(160,170,200,0.25);background:rgba(160,170,200,0.06);}
  .ctbl td{padding:6px 9px;border-bottom:1px solid rgba(160,170,200,0.10);color:var(--text2);}
  .ctbl tr:last-child td{border-bottom:none;}
  .v-ok{color:var(--green);font-family:'IBM Plex Mono',monospace;font-weight:600;}
  .v-diff{color:var(--yellow);font-family:'IBM Plex Mono',monospace;font-weight:600;}
  .alert-msg{font-size:0.79rem;padding:9px 0 2px;font-family:'IBM Plex Mono',monospace;line-height:1.6;}
  .alert-msg.red{color:var(--red);}
  .alert-msg.purple{color:var(--teal);}
  .group-warning-banner{background:rgba(255,152,0,0.12);border:1px solid rgba(255,152,0,0.40);border-radius:7px;padding:8px 12px;margin-top:9px;font-size:0.78rem;font-family:'IBM Plex Mono',monospace;color:#ff9800;display:flex;align-items:center;gap:8px;}
  .meta-row{font-size:0.72rem;color:var(--muted);margin-top:7px;}
  .meta-row span{color:var(--text2);}
  .results-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;}
  .results-title{font-size:0.87rem;font-weight:700;color:var(--accent);font-family:'IBM Plex Mono',monospace;}
  .mismatch-chip{display:inline-flex;align-items:center;gap:6px;background:rgba(90,96,128,.08);border:1px solid rgba(90,96,128,.28);border-radius:6px;padding:3px 9px;font-size:0.7rem;font-family:'IBM Plex Mono',monospace;color:var(--accent-mid);cursor:pointer;transition:background .2s;user-select:text;}
  .mismatch-chip:hover{background:rgba(90,96,128,.15);}
  .mismatch-chip .copy-icon{font-size:0.65rem;opacity:.7;}
  .export-bar{display:flex;flex-direction:column;gap:10px;margin-bottom:16px;padding:12px 14px;background:linear-gradient(145deg,rgba(255,255,255,0.90),rgba(245,247,255,0.86));border:1px solid rgba(160,170,200,0.32);border-radius:10px;box-shadow:var(--shadow);}
  .export-bar-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
  .export-bar-label{font-size:0.7rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;margin-right:4px;white-space:nowrap;}
  .export-btn{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:7px;border:1px solid rgba(160,170,200,0.35);background:rgba(255,255,255,0.65);color:var(--text2);font-size:0.78rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s;}
  .export-btn:hover{border-color:var(--accent-mid);color:var(--accent);background:var(--accent-glow);}
  .export-btn.excel:hover{border-color:var(--green);color:var(--green);background:rgba(26,107,58,0.08);}
  .export-btn.img:hover{border-color:var(--teal);color:var(--teal);background:rgba(26,122,122,0.08);}
  .export-sections-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;padding-top:8px;border-top:1px solid rgba(160,170,200,0.20);}
  .export-sections-label{font-size:0.65rem;font-family:'IBM Plex Mono',monospace;color:var(--muted2);text-transform:uppercase;letter-spacing:.7px;white-space:nowrap;}
  .export-chk-group{display:flex;align-items:center;gap:6px;cursor:pointer;user-select:none;}
  .export-chk-group input[type="checkbox"]{display:none;}
  .chk-box{width:15px;height:15px;border-radius:4px;border:1.5px solid rgba(160,170,200,0.40);background:rgba(245,247,252,0.80);display:inline-flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
  .export-chk-group input:checked + .chk-box{border-color:var(--accent-mid);background:var(--accent-glow);}
  .export-chk-group input:checked + .chk-box::after{content:'‚úì';font-size:0.65rem;color:var(--accent);font-weight:700;line-height:1;}
  .chk-label{font-size:0.72rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);transition:color .2s;}
  .chk-match input:checked + .chk-box{border-color:var(--green)!important;background:rgba(26,107,58,.12)!important;}
  .chk-match input:checked + .chk-box::after{color:var(--green)!important;}
  .chk-nohotel input:checked + .chk-box{border-color:var(--red)!important;background:rgba(155,32,32,.12)!important;}
  .chk-nohotel input:checked + .chk-box::after{color:var(--red)!important;}
  .chk-nosys input:checked + .chk-box{border-color:var(--teal)!important;background:rgba(26,122,122,.12)!important;}
  .chk-nosys input:checked + .chk-box::after{color:var(--teal)!important;}
  .chk-diff input:checked + .chk-box{border-color:var(--yellow)!important;background:rgba(122,96,16,.12)!important;}
  .chk-diff input:checked + .chk-box::after{color:var(--yellow)!important;}
  .smart-drop-zone{background:linear-gradient(145deg,rgba(255,255,255,0.90),rgba(245,247,255,0.86));border:2px dashed rgba(130,140,180,0.40);border-radius:14px;padding:0;margin-bottom:14px;transition:all .25s;position:relative;overflow:hidden;box-shadow:var(--shadow);}
  .smart-drop-zone.dragover{border-color:var(--accent-mid);background:var(--accent-glow);}
  .drop-inner{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:28px 24px;text-align:center;}
  .drop-icon{font-size:2.2rem;margin-bottom:10px;}
  .drop-title{font-size:0.92rem;font-weight:600;color:var(--text);margin-bottom:6px;}
  .drop-link{color:var(--accent);cursor:pointer;text-decoration:underline;}
  .drop-sub{font-size:0.75rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;margin-bottom:8px;}
  .drop-formats{font-size:0.68rem;color:var(--muted);font-family:'IBM Plex Mono',monospace;border:1px solid rgba(160,170,200,0.30);border-radius:20px;padding:3px 12px;display:inline-block;background:rgba(245,247,252,0.70);}
  .file-tags-wrap{padding:14px 16px 10px;}
  .file-tags{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;}
  .file-tag{display:flex;align-items:center;gap:7px;background:rgba(245,247,252,0.80);border:1px solid rgba(160,170,200,0.30);border-radius:8px;padding:6px 10px;font-size:0.74rem;font-family:'IBM Plex Mono',monospace;}
  .file-tag.hotel-tag{border-color:rgba(90,96,128,.40);background:rgba(90,96,128,.08);}
  .file-tag.system-tag{border-color:rgba(26,122,122,.40);background:rgba(26,122,122,.07);}
  .file-tag.unknown-tag{border-color:rgba(155,32,32,.30);background:rgba(155,32,32,.06);}
  .tag-type{font-size:0.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;padding:2px 5px;border-radius:4px;}
  .hotel-tag .tag-type{background:rgba(90,96,128,.18);color:var(--accent);}
  .system-tag .tag-type{background:rgba(26,122,122,.18);color:var(--teal);}
  .unknown-tag .tag-type{background:rgba(155,32,32,.15);color:var(--red);}
  .tag-name{color:var(--text);max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .tag-rm{background:transparent;border:none;color:var(--muted2);cursor:pointer;font-size:.85rem;padding:0 2px;line-height:1;}
  .tag-rm:hover{color:var(--red);}
  .add-more-btn{background:rgba(245,247,252,0.65);border:1px dashed rgba(130,140,180,.38);color:var(--muted);border-radius:7px;padding:5px 12px;font-size:0.74rem;cursor:pointer;transition:all .2s;font-family:inherit;}
  .add-more-btn:hover{border-color:var(--accent-mid);color:var(--accent);background:var(--accent-glow);}
  .type-select{background:rgba(245,247,252,0.80);border:1px solid rgba(160,170,200,0.30);color:var(--text);border-radius:5px;padding:2px 6px;font-size:0.72rem;font-family:'IBM Plex Mono',monospace;cursor:pointer;margin-left:4px;}
  .ignore-panel{background:linear-gradient(145deg,rgba(255,255,255,0.90),rgba(245,247,255,0.86));border:1px solid rgba(160,170,200,0.32);border-left:3px solid rgba(255,152,0,0.70);border-radius:10px;padding:11px 14px;margin-bottom:16px;box-shadow:var(--shadow);}
  .ignore-panel-hdr{display:flex;align-items:center;gap:8px;margin-bottom:9px;}
  .ignore-panel-title{font-size:0.72rem;font-family:'IBM Plex Mono',monospace;color:#ff9800;text-transform:uppercase;letter-spacing:.8px;font-weight:700;}
  .ignore-panel-desc{font-size:0.68rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);margin-left:auto;}
  .ignore-chks{display:flex;gap:14px;flex-wrap:wrap;align-items:center;}
  .ignore-chk-group{display:flex;align-items:center;gap:7px;cursor:pointer;user-select:none;}
  .ignore-chk-group input[type="checkbox"]{display:none;}
  .ignore-chk-box{width:17px;height:17px;border-radius:4px;border:1.5px solid rgba(255,152,0,0.40);background:rgba(255,152,0,0.06);display:inline-flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
  .ignore-chk-group input:checked + .ignore-chk-box{border-color:#ff9800;background:rgba(255,152,0,0.18);}
  .ignore-chk-group input:checked + .ignore-chk-box::after{content:'‚úì';font-size:0.72rem;color:#ff9800;font-weight:700;line-height:1;}
  .ignore-chk-label{font-size:0.76rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);transition:color .2s;}
  .ignore-chk-group input:checked ~ .ignore-chk-label{color:#ff9800;}
  [data-theme="dark"] .ignore-panel{background:#0f1623;border-color:#243347;border-left-color:rgba(255,152,0,0.70);}
  [data-theme="dark"] .ignore-chk-box{background:rgba(255,152,0,0.06);border-color:rgba(255,152,0,0.30);}
  [data-theme="dark"] .ignore-chk-group input:checked + .ignore-chk-box{border-color:#ff9800;background:rgba(255,152,0,0.15);}
  .lang-btn{background:rgba(245,247,252,0.85);border:1px solid rgba(26,122,122,0.45);color:var(--teal);border-radius:8px;padding:6px 14px;font-size:0.82rem;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s;letter-spacing:.5px;box-shadow:0 1px 4px rgba(0,0,0,0.06);}
  .lang-btn:hover{background:rgba(26,122,122,0.10);border-color:var(--teal-light);}
  .powered-footer{text-align:center;margin-top:36px;padding:20px 16px 16px;border-top:1px solid rgba(160,170,200,0.28);position:relative;direction:ltr;}
  .pf-tag{font-size:0.65rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);text-transform:uppercase;letter-spacing:1.4px;margin-bottom:6px;}
  .pf-name{font-size:1.05rem;font-weight:700;color:var(--text);margin-bottom:8px;letter-spacing:.5px;}
  .pf-name span{color:var(--accent);}
  .pf-contacts{display:flex;justify-content:center;gap:22px;flex-wrap:wrap;}
  .pf-contact{display:flex;align-items:center;gap:7px;font-size:0.8rem;font-family:'IBM Plex Mono',monospace;color:var(--muted);}
  .pf-contact a{color:var(--muted);text-decoration:none;transition:color .2s;}
  .pf-contact a:hover{color:var(--accent);}
  .paste-section{display:none;}
  .paste-toggle{background:transparent;border:none;color:var(--muted2);font-size:0.72rem;font-family:'IBM Plex Mono',monospace;cursor:pointer;padding:4px 0;margin-top:6px;display:flex;align-items:center;gap:5px;transition:color .2s;}
  .paste-toggle:hover{color:var(--accent);}
  .paste-toggle .arrow{transition:transform .2s;display:inline-block;}
  .paste-toggle.open .arrow{transform:rotate(90deg);}
  .paste-section.visible{display:block;}
  .app-wrapper{max-width:1100px;margin:0 auto;width:100%;}
  .theme-btn{background:rgba(245,247,252,0.85);border:1px solid rgba(90,96,128,0.45);color:var(--accent);border-radius:8px;padding:6px 14px;font-size:0.82rem;font-weight:700;cursor:pointer;font-family:inherit;transition:all .2s;letter-spacing:.3px;box-shadow:0 1px 4px rgba(0,0,0,0.06);display:flex;align-items:center;gap:6px;}
  .theme-btn:hover{background:var(--accent-glow);}
  /* DARK MODE */
  [data-theme="dark"]{--bg:#07090f;--bg2:#0a0d16;--surface:#0f1623;--surface2:#16202e;--border:#243347;--border2:#1a2840;--accent:#00c8ff;--accent-mid:#00c8ff;--accent-light:#33d4ff;--accent-glow:rgba(0,200,255,0.10);--teal:#00c8ff;--teal-light:#33d4ff;--green:#00e676;--red:#ff4757;--yellow:#ffd600;--purple:#b388ff;--text:#dde6f0;--text2:#b0c4d8;--muted:#5a7490;--muted2:#3d5166;--shadow:0 4px 20px rgba(0,0,0,0.40),0 1px 4px rgba(0,0,0,0.30);--shadow-hover:0 8px 32px rgba(0,0,0,0.55),0 2px 8px rgba(0,0,0,0.35);}
  [data-theme="dark"] body{background-color:#07090f;background-image:radial-gradient(ellipse at 50% 0%,rgba(0,200,255,0.18) 0%,transparent 60%),radial-gradient(ellipse at 0% 60%,rgba(0,120,255,0.14) 0%,transparent 50%),radial-gradient(ellipse at 100% 40%,rgba(80,0,200,0.12) 0%,transparent 50%),radial-gradient(ellipse at 50% 100%,rgba(0,60,180,0.20) 0%,transparent 55%),linear-gradient(170deg,#07090f 0%,#090d1a 35%,#070b16 65%,#050810 100%);}
  [data-theme="dark"] header{background:linear-gradient(135deg,rgba(15,22,35,0.98) 0%,rgba(22,32,46,0.95) 100%);border-color:#243347;border-top-color:#00c8ff;}
  [data-theme="dark"] h1{color:#fff;}
  [data-theme="dark"] h1 span{color:#00c8ff;}
  [data-theme="dark"] .upload-card{background:linear-gradient(145deg,#0f1623,#16202e);border-color:#243347;border-top-color:#00c8ff44;}
  [data-theme="dark"] .file-slot{background:#16202e;border-color:#243347;}
  [data-theme="dark"] .file-slot:hover,[data-theme="dark"] .file-slot.dragover{background:rgba(0,200,255,0.06);border-color:#00c8ff;}
  [data-theme="dark"] .add-file-btn{background:transparent;border-color:#3d5166;color:#5a7490;}
  [data-theme="dark"] .add-file-btn:hover{border-color:#00c8ff;color:#00c8ff;background:rgba(0,200,255,0.06);}
  [data-theme="dark"] textarea.paste-box{background:#16202e;border-color:#243347;color:#dde6f0;}
  [data-theme="dark"] textarea.paste-box:focus{border-color:#00c8ff;box-shadow:0 0 0 3px rgba(0,200,255,0.10);}
  [data-theme="dark"] .compare-btn{background:#00c8ff;color:#000;box-shadow:0 4px 18px rgba(0,200,255,0.30);text-shadow:none;}
  [data-theme="dark"] .compare-btn:hover{background:#33d4ff;box-shadow:0 6px 24px rgba(0,200,255,0.40);}
  [data-theme="dark"] .stat{background:#0f1623;border-color:#243347;}
  [data-theme="dark"] .s-total .num{color:#00c8ff;}
  [data-theme="dark"] .s-match .num{color:#00e676;}
  [data-theme="dark"] .s-diff .num{color:#ffd600;}
  [data-theme="dark"] .s-nohotel .num{color:#ff4757;}
  [data-theme="dark"] .s-nosys .num{color:#b388ff;}
  [data-theme="dark"] .s-nosys.active-stat{border-color:#b388ff;box-shadow:0 0 0 2px rgba(179,136,255,0.18);}
  [data-theme="dark"] .search-box{background:#0f1623;border-color:#243347;color:#dde6f0;box-shadow:none;}
  [data-theme="dark"] .search-box:focus{border-color:#00c8ff;box-shadow:0 0 0 3px rgba(0,200,255,0.10);}
  [data-theme="dark"] .search-box::placeholder{color:#3d5166;}
  [data-theme="dark"] .section-hdr{border-color:#243347;}
  [data-theme="dark"] .result-item{background:#0f1623;border-color:#243347;box-shadow:0 2px 10px rgba(0,0,0,0.3);}
  [data-theme="dark"] .result-item:hover{border-color:#2e4560;}
  [data-theme="dark"] .result-body{background:rgba(22,32,46,0.60);border-top-color:#243347;}
  [data-theme="dark"] .rsv-num{color:#00c8ff;}
  [data-theme="dark"] .rsv-copy-btn{border-color:#243347;color:#5a7490;}
  [data-theme="dark"] .rsv-copy-btn:hover{color:#00c8ff;border-color:#00c8ff;background:rgba(0,200,255,0.08);}
  [data-theme="dark"] .rsv-copy-btn.copied{color:#00e676;border-color:#00e676;background:rgba(0,230,118,0.08);}
  [data-theme="dark"] .guest-name{color:#dde6f0;}
  [data-theme="dark"] .bd-match{background:rgba(0,230,118,.15);color:#00e676;border-color:rgba(0,230,118,.25);}
  [data-theme="dark"] .bd-diff{background:rgba(255,214,0,.15);color:#ffd600;border-color:rgba(255,214,0,.25);}
  [data-theme="dark"] .bd-nohotel{background:rgba(255,71,87,.15);color:#ff4757;border-color:rgba(255,71,87,.25);}
  [data-theme="dark"] .bd-nosys{background:rgba(179,136,255,.15);color:#b388ff;border-color:rgba(179,136,255,.25);}
  [data-theme="dark"] .ctbl th{background:rgba(0,200,255,0.04);border-color:#243347;color:#5a7490;}
  [data-theme="dark"] .ctbl td{border-color:rgba(36,51,71,0.5);color:#b0c4d8;}
  [data-theme="dark"] .v-ok{color:#00e676;}
  [data-theme="dark"] .v-diff{color:#ffd600;}
  [data-theme="dark"] .alert-msg.red{color:#ff4757;}
  [data-theme="dark"] .alert-msg.purple{color:#b388ff;}
  [data-theme="dark"] .group-warning-banner{background:rgba(255,152,0,0.10);border-color:rgba(255,152,0,0.35);color:#ff9800;}
  [data-theme="dark"] .results-title{color:#dde6f0;}
  [data-theme="dark"] .mismatch-chip{background:rgba(255,214,0,.08);border-color:rgba(255,214,0,.3);color:#ffd600;}
  [data-theme="dark"] .export-bar{background:#0f1623;border-color:#243347;}
  [data-theme="dark"] .export-btn{background:transparent;border-color:#243347;color:#dde6f0;}
  [data-theme="dark"] .export-btn:hover{border-color:#00c8ff;color:#00c8ff;background:rgba(0,200,255,0.06);}
  [data-theme="dark"] .export-btn.excel:hover{border-color:#00e676;color:#00e676;background:rgba(0,230,118,0.06);}
  [data-theme="dark"] .export-btn.img:hover{border-color:#b388ff;color:#b388ff;background:rgba(179,136,255,0.06);}
  [data-theme="dark"] .chk-box{background:#16202e;border-color:#243347;}
  [data-theme="dark"] .export-chk-group input:checked + .chk-box{border-color:#00c8ff;background:rgba(0,200,255,0.12);}
  [data-theme="dark"] .export-chk-group input:checked + .chk-box::after{color:#00c8ff;}
  [data-theme="dark"] .smart-drop-zone{background:#0f1623;border-color:#243347;}
  [data-theme="dark"] .smart-drop-zone.dragover{border-color:#00c8ff;background:rgba(0,200,255,0.05);}
  [data-theme="dark"] .drop-formats{background:#16202e;border-color:#243347;}
  [data-theme="dark"] .file-tag{background:#16202e;border-color:#243347;}
  [data-theme="dark"] .file-tag.hotel-tag{border-color:rgba(0,200,255,0.4);background:rgba(0,200,255,0.06);}
  [data-theme="dark"] .file-tag.system-tag{border-color:rgba(0,230,118,0.4);background:rgba(0,230,118,0.06);}
  [data-theme="dark"] .file-tag.unknown-tag{border-color:rgba(255,214,0,0.4);background:rgba(255,214,0,0.06);}
  [data-theme="dark"] .hotel-tag .tag-type{background:rgba(0,200,255,0.2);color:#00c8ff;}
  [data-theme="dark"] .system-tag .tag-type{background:rgba(0,230,118,0.2);color:#00e676;}
  [data-theme="dark"] .unknown-tag .tag-type{background:rgba(255,214,0,0.2);color:#ffd600;}
  [data-theme="dark"] .add-more-btn{background:transparent;border-color:#3d5166;color:#5a7490;}
  [data-theme="dark"] .add-more-btn:hover{border-color:#00c8ff;color:#00c8ff;background:rgba(0,200,255,0.06);}
  [data-theme="dark"] .type-select{background:#16202e;border-color:#243347;color:#dde6f0;}
  [data-theme="dark"] .lang-btn{background:transparent;border-color:#00c8ff;color:#00c8ff;}
  [data-theme="dark"] .lang-btn:hover{background:rgba(0,200,255,0.10);}
  [data-theme="dark"] .theme-btn{background:#16202e;border-color:#243347;color:#5a7490;}
  [data-theme="dark"] .theme-btn:hover{border-color:#00c8ff;color:#00c8ff;background:rgba(0,200,255,0.08);}
  [data-theme="dark"] .btn-clear{background:#16202e;border-color:rgba(255,71,87,0.4);color:#ff4757;}
  [data-theme="dark"] .btn-clear:hover{background:rgba(255,71,87,0.10);}
  [data-theme="dark"] .powered-footer{border-top-color:#243347;}
  [data-theme="dark"] .pf-name{color:#fff;}
  [data-theme="dark"] .pf-name span{color:#00c8ff;}
  [data-theme="dark"] .paste-toggle{color:#3d5166;}
  [data-theme="dark"] .paste-toggle:hover{color:#00c8ff;}
  [data-theme="dark"] .sd-nosys{background:#b388ff;}
  [data-theme="dark"] .export-sections-row{border-top-color:#243347;}
</style>
</head>
<body>
<div class="app-wrapper">

<header>
  <div id="headerTitle">
    <h1 id="mainTitle">ALTANTAWY <span>Comparison</span> Tool</h1>
    <p class="subtitle" id="mainSubtitle">FOR AL SAFWAH TOWER 3 HOTEL</p>
  </div>
</header>

<div class="top-actions">
  <button class="theme-btn" id="themeBtn" onclick="toggleTheme()">‚òÄÔ∏è Light Mode</button>
  <button class="lang-btn" id="langBtn" onclick="toggleLang()">üåê ÿπÿ±ÿ®Ÿä</button>
  <button class="btn-clear" id="btnClear" onclick="hardReset()">üóë Clear All &amp; Reset</button>
</div>

<div id="smartDrop" class="smart-drop-zone" style="display:none">
  <input type="file" id="smartFileInput" multiple accept=".pdf,.txt,.csv" style="display:none">
  <div class="drop-inner" id="dropInner">
    <div class="drop-icon">üìÇ</div>
    <div class="drop-title" id="dropTitle">Drop files here or <span class="drop-link" onclick="document.getElementById('smartFileInput').click()">browse</span></div>
    <div class="drop-sub" id="dropSub">Select both Hotel &amp; System files at once ‚Äî app auto-detects type</div>
    <div class="drop-formats" id="dropFormats">PDF ¬∑ TXT ¬∑ CSV &nbsp;¬∑&nbsp; Multiple files supported</div>
  </div>
  <div id="fileTagsWrap" class="file-tags-wrap" style="display:none">
    <div id="fileTags" class="file-tags"></div>
    <button class="add-more-btn" onclick="document.getElementById('smartFileInput').click()">Ôºã Add More Files</button>
  </div>
</div>

<div class="upload-grid">
  <div class="upload-card">
    <div class="card-label" id="hotelCardLabel">Hotel File(s)</div>
    <div class="card-title" id="hotelCardTitle">üè® Hotel Main File</div>
    <div class="file-slots" id="hotelSlots"></div>
    <button class="add-file-btn" onclick="addHotelSlot()" id="addHotelBtn">Ôºã Add Hotel File Manually</button>
    <button class="paste-toggle" id="hotelPasteToggle" onclick="togglePaste('hotel')"><span class="arrow">‚ñ∂</span> <span id="hotelPasteLabel">Or paste hotel text</span></button>
    <div class="paste-section" id="hotelPasteSection">
      <textarea class="paste-box" id="hotelPaste" placeholder="Paste hotel reservation text here..."></textarea>
    </div>
  </div>
  <div class="upload-card">
    <div class="card-label" id="sysCardLabel">System File(s)</div>
    <div class="card-title" id="sysCardTitle">üñ• System Files</div>
    <div class="file-slots" id="systemSlots"></div>
    <button class="add-file-btn" onclick="addSystemSlot()" id="addSysBtn">Ôºã Add System File Manually</button>
    <button class="paste-toggle" id="systemPasteToggle" onclick="togglePaste('system')"><span class="arrow">‚ñ∂</span> <span id="sysPasteLabel">Or paste system text</span></button>
    <div class="paste-section" id="systemPasteSection">
      <textarea class="paste-box" id="systemPaste" placeholder="Paste system reservation text here..."></textarea>
    </div>
  </div>
</div>

<button class="compare-btn" onclick="runComparison()" id="compareBtn">‚ö° Run Comparison</button>

<div class="ignore-panel">
  <div class="ignore-panel-hdr">
    <span style="font-size:1.1rem;">üö´</span>
    <span class="ignore-panel-title">Ignore Mismatch</span>
    <span class="ignore-panel-desc">Checked fields will be skipped during comparison ‚Äî results update instantly</span>
  </div>
  <div class="ignore-chks">
    <label class="ignore-chk-group">
      <input type="checkbox" id="ignoreArrival" onchange="rerunIfHasResults()">
      <span class="ignore-chk-box"></span>
      <span class="ignore-chk-label">üìÖ Arrival</span>
    </label>
    <label class="ignore-chk-group">
      <input type="checkbox" id="ignoreGuest" onchange="rerunIfHasResults()">
      <span class="ignore-chk-box"></span>
      <span class="ignore-chk-label">üë§ Guest Name</span>
    </label>
    <label class="ignore-chk-group">
      <input type="checkbox" id="ignoreView" onchange="rerunIfHasResults()">
      <span class="ignore-chk-box"></span>
      <span class="ignore-chk-label">ü™ü View Type</span>
    </label>
  </div>
</div>

<div id="results"></div>

<script>
// ‚îÄ‚îÄ DEMO DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const HOTEL_DATA = {
  '138992':{ name:'Travel Gate GROUP',           from:'21/02/2026', till:'01/03/2026', rooms:15 },
  '140241':{ name:'Yazan Nadi',                  from:'21/02/2026', till:'24/02/2026', rooms:1  },
  '140206':{ name:'Mohamed Hossam',              from:'21/02/2026', till:'27/02/2026', rooms:4  },
  '140198':{ name:'ABDELRAHMAN ALQAWASMEH',      from:'21/02/2026', till:'24/02/2026', rooms:1  },
  '138977':{ name:'Khaled Nasser',               from:'21/02/2026', till:'25/02/2026', rooms:2  },
  '140164':{ name:'Abdul Salam Bahleel',         from:'21/02/2026', till:'01/03/2026', rooms:1  },
  '140553':{ name:'Abdulrahman Al Tuaimi',       from:'21/02/2026', till:'22/02/2026', rooms:1  },
  '140523':{ name:'Kheer Al Belad',              from:'21/02/2026', till:'27/02/2026', rooms:9  },
  '140173':{ name:'Abdulaziz Ibrahim Al-Salmi',  from:'21/02/2026', till:'22/02/2026', rooms:2  },
  '140301':{ name:'Badriya Thabit AlQahtani',    from:'21/02/2026', till:'23/02/2026', rooms:1  },
};

const SYSTEM_DATA = [
  {rsv:'137001',from:'21/02/2026',till:'25/02/2026',rooms:1,guest:'Tariq Abu Mayaleh',hotel:'Ponsiana Hotel',htlRsv:'2086'},
  {rsv:'138758',from:'21/02/2026',till:'04/03/2026',rooms:1,guest:'Abdullah Hamad Abdullah',hotel:'Ponsiana Hotel',htlRsv:'2088'},
  {rsv:'140241',from:'21/02/2026',till:'24/02/2026',rooms:1,guest:'Yazan Nadi',hotel:'Ponsiana Hotel',htlRsv:'sent'},
  {rsv:'140206',from:'21/02/2026',till:'27/02/2026',rooms:4,guest:'Mohamed Hossam',hotel:'Ponsiana Hotel',htlRsv:'sent'},
];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let hotelMap       = {};
let systemList     = [];
let rawResults     = [];  // full unfiltered diff data (all fields, ignoring no flags)
let currentResults = [];  // results after applying ignore flags (what gets rendered)
let currentFilter  = 'all';
let currentSearch  = '';

// Apply ignore flags to rawResults and re-render without re-parsing files.
// Each raw result stores ALL diffs in _allDiffs; we filter before deciding match/diff status.
function applyIgnoreFlagsAndRender() {
  const ign = getIgnoreFlags();
  currentResults = rawResults.map(r => {
    if (r.status === 'nohotel' || r.status === 'nosys') return r;
    // Filter out only the ignored fields ‚Äî remaining diffs still count
    const visibleDiffs = (r._allDiffs || []).filter(d => {
      if (ign.arrival && d.f === 'Arrival')    return false;
      if (ign.guest   && d.f === 'Guest Name') return false;
      if (ign.view    && d.f === 'View Type')  return false;
      return true;
    });
    return { ...r, diffs: visibleDiffs, status: visibleDiffs.length ? 'diff' : 'match' };
  });
  renderResults();
}

function hardReset() {
  hotelMap={}; systemList=[]; currentResults=[]; rawResults=[]; currentFilter='all'; currentSearch='';
  loadedFiles=[];
  document.getElementById('hotelSlots').innerHTML='';
  document.getElementById('systemSlots').innerHTML='';
  document.getElementById('hotelPaste').value='';
  document.getElementById('systemPaste').value='';
  document.getElementById('results').innerHTML='';
  document.getElementById('fileTags').innerHTML='';
  document.getElementById('fileTagsWrap').style.display='none';
  document.getElementById('dropInner').style.display='';
  addHotelSlot(); addSystemSlot();
  toast('Reset complete ‚Äî ready for new comparison');
}

function addHotelSlot() {
  const container = document.getElementById('hotelSlots');
  const div = document.createElement('div');
  div.className = 'file-slot';
  div.innerHTML = `<input type="file" accept=".pdf,.txt,.csv">
    <span class="slot-icon">üìÑ</span>
    <div class="slot-info"><div class="slot-label">Hotel file ‚Äî click or drag &amp; drop</div><div class="slot-name"></div></div>
    <button class="remove-slot" title="Remove">‚úï</button>`;
  container.appendChild(div);
  wireSlot(div, 'hotel');
}

function addSystemSlot() {
  const container = document.getElementById('systemSlots');
  const div = document.createElement('div');
  div.className = 'file-slot';
  div.innerHTML = `<input type="file" accept=".pdf,.txt,.csv">
    <span class="slot-icon">üìã</span>
    <div class="slot-info"><div class="slot-label">System file ‚Äî click or drag &amp; drop</div><div class="slot-name"></div></div>
    <button class="remove-slot" title="Remove">‚úï</button>`;
  container.appendChild(div);
  wireSlot(div, 'system');
}

function wireSlot(div, type) {
  const input  = div.querySelector('input[type="file"]');
  const nameEl = div.querySelector('.slot-name');
  const rm     = div.querySelector('.remove-slot');
  div.addEventListener('click', e => { if (!e.target.closest('.remove-slot')) input.click(); });
  rm.addEventListener('click', e => { e.stopPropagation(); div.remove(); });
  div.addEventListener('dragover',  e => { e.preventDefault(); div.classList.add('dragover'); });
  div.addEventListener('dragleave', () => div.classList.remove('dragover'));
  div.addEventListener('drop', e => {
    e.preventDefault(); div.classList.remove('dragover');
    const f = e.dataTransfer.files[0];
    if (f) { nameEl.textContent = f.name; nameEl.classList.add('visible'); handleFile(f, type); }
  });
  input.addEventListener('change', e => {
    const f = e.target.files[0];
    if (f) { nameEl.textContent = f.name; nameEl.classList.add('visible'); handleFile(f, type); }
  });
}

async function handleFile(file, type) {
  let text = '';
  if (file.name.toLowerCase().endsWith('.pdf')) {
    try { text = await extractPdfText(file); }
    catch(e) { toast('PDF parse failed ‚Äî try pasting the text instead.'); return; }
  } else {
    text = await file.text();
  }
  if (type === 'hotel') {
    const parsed = parseHotelText(text);
    for (const [v, d] of Object.entries(parsed)) {
      hotelMap[v] = hotelMap[v] ? { ...hotelMap[v], rooms: hotelMap[v].rooms + d.rooms } : d;
    }
    toast('Hotel file parsed: ' + Object.keys(parsed).length + ' voucher(s)');
  } else {
    const parsed = parseSystemText(text);
    systemList.push(...parsed);
    toast('System file parsed: ' + parsed.length + ' reservation(s)');
  }
}

let _pdfLib = null;
async function extractPdfText(file) {
  if (!_pdfLib) {
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
      s.onload = () => { pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js'; _pdfLib=pdfjsLib; res(); };
      s.onerror = rej;
      document.head.appendChild(s);
    });
  }
  const buf = await file.arrayBuffer();
  const pdf = await _pdfLib.getDocument({ data: buf }).promise;
  let out = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const pg = await pdf.getPage(i);
    const c  = await pg.getTextContent();
    out += c.items.map(x => x.str + (x.hasEOL ? '\n' : ' ')).join('') + '\n';
  }
  return out;
}

// ‚îÄ‚îÄ VIEW NORMALISATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function normaliseView(raw) {
  const s = (raw || '').toUpperCase().replace(/\s+/g,'');
  if (/^T\d+DNV/i.test(s))  return 'Non View';
  if (/^T\d+CTV/i.test(s))  return 'Partial Haram';
  if (/^(SNV|DNV)/.test(s)) return 'Non View';
  if (/^(CTV|STV|STCV|CTVP)/.test(s)) return 'Partial Haram';
  if (/NON.?VIEW/i.test(raw))     return 'Non View';
  if (/PARTIAL.?HARAM/i.test(raw))return 'Partial Haram';
  if (/HARAM.?VIEW/i.test(raw))   return 'Haram View';
  if (/CITY.?VIEW/i.test(raw))    return 'City view';
  return 'Non View';
}

// ‚îÄ‚îÄ ROOM TYPE NORMALISATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function normaliseRoomType(raw) {
  const s = (raw || '').toUpperCase().replace(/\s+/g,'').replace(/-/g,'');
  if (/^(SGL|1|SINGLE)/.test(s))           return 'SGL';
  if (/^(DBL|2|DOUBLE|TWN|TWIN)/.test(s))  return 'DBL';
  if (/^(TPL|TRP|TRPL|3|TRIPLE)/.test(s))  return 'TPL';
  if (/^(QUAD|QUD|4|QUADRUPLE)/.test(s))   return 'QUAD';
  return raw;
}

function paxToRoomType(n) {
  const i = parseInt(n, 10);
  if (i === 1) return 'SGL';
  if (i === 2) return 'DBL';
  if (i === 3) return 'TPL';
  if (i === 4) return 'QUAD';
  return 'DBL';
}

// ‚îÄ‚îÄ MEAL PLAN NORMALISATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function normaliseMeal(raw) {
  const cleaned = (raw || '').replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();
  const s = cleaned.toUpperCase();

  if (/IFTAR\s+AND\s+S[AO]H[OUR]+/i.test(cleaned)) return 'Iftar+Sohour';

  const isEconomy = /\bECONOMY\b|\bF\.B\b|\bFULL.?BOARD\b/.test(s);
  if (isEconomy) return 'Iftar+Sohour';

  const hasIftar  = /IFTAR/.test(s);
  const hasSohour = /SAH(O|U)(U|O)R|SOHOUR|SAHOUR|SAHUR/.test(s);
  const hasBreak  = /\bBF\b|BREAKFAST/.test(s);

  if (hasIftar && hasSohour) return 'Iftar+Sohour';
  if (hasIftar)  return 'Iftar';
  if (hasSohour) return 'Sohour';
  if (hasBreak)  return 'Breakfast';

  if (/\bR\.?O\b/i.test(cleaned)) return 'RO';
  if (/\bF\.?B\b/i.test(cleaned)) return 'Iftar+Sohour';

  return cleaned || '';
}

// ‚îÄ‚îÄ GUEST NAME MATCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function guestNamesMatch(a, b) {
  if (!a || !b) return true;
  const norm = s => s.toUpperCase().replace(/,/g,' ').replace(/-/g,' ').replace(/\s+/g,' ').trim();
  const na = norm(a), nb = norm(b);
  if (na === nb) return true;
  const sortTok = s => s.split(' ').filter(Boolean).sort().join('|');
  if (sortTok(na) === sortTok(nb)) return true;
  function tryReorder(raw, flatNorm) {
    const parts = raw.replace(/-/g,' ').split(/,\s*/);
    if (parts.length !== 2) return false;
    const reordered = norm(parts[1] + ' ' + parts[0]);
    return reordered === flatNorm || sortTok(reordered) === sortTok(flatNorm);
  }
  if (a.includes(',') && tryReorder(a, nb)) return true;
  if (b.includes(',') && tryReorder(b, na)) return true;
  function swapLastToFront(s) {
    const w = s.split(' ');
    if (w.length < 2) return s;
    return (w[w.length - 1] + ' ' + w.slice(0, -1).join(' ')).trim();
  }
  if (swapLastToFront(na) === nb) return true;
  if (swapLastToFront(nb) === na) return true;
  const noSpace = s => s.replace(/\s+/g,'');
  if (noSpace(na) === noSpace(nb)) return true;
  return false;
}

// ‚îÄ‚îÄ GROUP NAME DETECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function isGroupName(name) {
  if (!name) return false;
  const s = name.toUpperCase().trim();
  return /\bGROUP\b|\bGRP\b/.test(s) || /\bGR\b/.test(s) || s === 'GR' || /\s+GR$/.test(s);
}

// ‚îÄ‚îÄ DATE NORMALISATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function normDateHotel(s) {
  if (!s) return s;
  const parts = s.trim().split('/');
  if (parts.length !== 3) return s;
  let [d, m, y] = parts;
  if (y.length === 2) y = '20' + y;
  return `${d.padStart(2,'0')}/${m.padStart(2,'0')}/${y}`;
}

function extractDate(raw) {
  if (!raw) return '';
  const match = raw.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
  if (!match) return '';
  return normDateHotel(match[1].replace(/-/g,'/'));
}

// ‚îÄ‚îÄ HOTEL TEXT PARSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseHotelText(text) {
  const ctx   = parseHotelTextByContext(text);
  const blk   = parseHotelTextByBlock(text);
  const allConfs = new Set([...Object.keys(ctx), ...Object.keys(blk)]);
  const merged = {};
  for (const conf of allConfs) {
    const c = ctx[conf];
    const b = blk[conf];
    if (c && b) {
      merged[conf] = {
        ...c,
        till:     c.till     || b.till,
        from:     c.from     || b.from,
        name:     c.name     || b.name,
        mealType: c.mealType || b.mealType,
        viewType: c.viewType || b.viewType,
        roomType: c.roomType || b.roomType,
      };
    } else {
      merged[conf] = c || b;
    }
  }
  return merged;
}

function parseHotelTextByContext(text) {
  const result = {};
  const confRe = /\b(4\d{8})\b/g;
  const confMatches = [...text.matchAll(confRe)];

  for (let ci = 0; ci < confMatches.length; ci++) {
    const cm     = confMatches[ci];
    const confNo = cm[1];
    const pos    = cm.index;

    const tightBefore = text.substring(Math.max(0, pos - 400), pos);
    const wideBefore  = text.substring(Math.max(0, pos - 800), pos);
    const after       = text.substring(pos, Math.min(text.length, pos + 500));

    const rtRe = /\b(T\d+(?:DNV|CTV)[A-Z0-9]*|CTVP\d*|DNV[A-Z0-9]*|SNV[A-Z0-9]*|CTV[A-Z0-9]*|STCV[A-Z0-9]*|DNVP\d*)\s+(\d)\s+(\d)\s+(\d)\b/i;
    const rtM  = tightBefore.match(rtRe);
    if (!rtM) continue;

    const roomTypeCode = rtM[1].toUpperCase();
    const paxCount     = parseInt(rtM[2], 10);
    const roomCount    = parseInt(rtM[4], 10);

    const beforeRoomCode = tightBefore.substring(0, rtM.index);
    const datesBeforeRoom = [...beforeRoomCode.matchAll(/(\d{2}\/\d{2}\/\d{2,4})/g)];

    const afterConf = text.substring(pos, Math.min(text.length, pos + 300));
    const datesAfterConf = [...afterConf.matchAll(/(\d{2}\/\d{2}\/\d{2,4})/g)];

    let arrival = '', departure = '';

    if (datesBeforeRoom.length >= 2) {
      arrival   = normDateHotel(datesBeforeRoom[datesBeforeRoom.length - 2][1]);
      departure = normDateHotel(datesBeforeRoom[datesBeforeRoom.length - 1][1]);
    } else if (datesBeforeRoom.length === 1) {
      arrival = normDateHotel(datesBeforeRoom[0][1]);
      for (const dm of datesAfterConf) {
        const d = normDateHotel(dm[1]);
        if (d !== arrival) { departure = d; break; }
      }
      if (!departure) continue;
    } else {
      const allTightDates = [...tightBefore.matchAll(/(\d{2}\/\d{2}\/\d{2,4})/g)];
      if (allTightDates.length >= 2) {
        arrival   = normDateHotel(allTightDates[allTightDates.length - 2][1]);
        departure = normDateHotel(allTightDates[allTightDates.length - 1][1]);
      } else {
        continue;
      }
    }

    const pkgM = after.match(/((?:IFTAR\s+RAM\s+\d+|SAHOUR\s+RAM\s+\d+|SOHOUR\s+RAM\s+\d+|SAHUR\s+RAM\s+\d+|BF\s+\d+\s+NEW)[\s,]*)+/gi);
    const mealType = normaliseMeal(pkgM ? pkgM[0] : '');

    let guestName = '';
    const guestRe = /XXXXXX\s+([\w\s,.'\/\-]+?)\s+T-\s*Askant/gi;
    const guestMs = [...wideBefore.matchAll(guestRe)];
    if (guestMs.length) guestName = cleanGuestName(guestMs[guestMs.length - 1][1]);

    result[confNo] = {
      name:     guestName,
      from:     arrival,
      till:     departure,
      rooms:    roomCount,
      roomType: paxToRoomType(paxCount),
      mealType: mealType,
      viewType: normaliseView(roomTypeCode),
    };
  }
  return result;
}

// SECONDARY: block-based parser
// FIX v36: The original code had a literal newline character inside a regex character class
// /Dep\.\s*Date\s+((?:\d{2}\/\d{2}\/\d{2,4}[\s<LF>]*)+)/i
// which is a SyntaxError. Fixed to use [\s\S]*? instead.
function parseHotelTextByBlock(text) {
  const result = {};
  const onePkgRe = /(?:IFTAR\s+RAM\s+\d+|SAHOUR\s+RAM\s+\d+|SOHOUR\s+RAM\s+\d+|SAHUR\s+RAM\s+\d+|BF\s+\d+\s+NEW)(?:,\s*(?:IFTAR\s+RAM\s+\d+|SAHOUR\s+RAM\s+\d+|SOHOUR\s+RAM\s+\d+|SAHUR\s+RAM\s+\d+|BF\s+\d+\s+NEW))*/gi;
  const roomCodeRe = /\b(?:T\d+(?:DNV|CTV)[A-Z0-9]*|CTVP\d*|DNVP\d*|DNV[A-Z0-9]*|SNV[A-Z0-9]*|CTV[A-Z0-9]*|STCV[A-Z0-9]*)\b/gi;
  const blockSplitRe = /(?=(?:2506ASKANT\s+Block|Block\s+2506ASKANT))/gi;
  const blocks = text.split(blockSplitRe).filter(b => /2506ASKANT[\s\S]{0,20}Block|Block[\s\S]{0,20}2506ASKANT/i.test(b));

  for (const block of blocks) {
    // FIX: was /Dep\.\s*Date\s+((?:\d{2}\/\d{2}\/\d{2,4}[\s\n]*)+)/i
    // The [\s\n*] contained a raw newline byte which is invalid in a regex literal.
    // Changed to [\s\S]*? which safely matches any whitespace including newlines.
    let depDates = [];
    const depColM = block.match(/Dep\.\s*Date\s+((?:\d{2}\/\d{2}\/\d{2,4}[\s\S]*?)+(?=\n\n|\w{4,}|$))/i);
    if (depColM) {
      depDates = depColM[1].match(/\d{2}\/\d{2}\/\d{2,4}/g) || [];
    } else {
      const allDatesInBlock = [...block.matchAll(/(\d{2}\/\d{2}\/\d{2,4})/g)];
      const earlyDates = allDatesInBlock.filter(m => m.index < block.length * 0.4);
      depDates = earlyDates.map(m => m[1]);
    }
    const adlM      = block.match(/\bCompany\b\s+([\d\s]+?)\s*\bChl\b/i);
    const adls      = adlM ? adlM[1].match(/\b[1-9]\b/g) || [] : [];
    const rmsM      = block.match(/\bRms\.\s+([\s\S]*?)\bRoom\s+Type\b/i);
    const roomCodes = rmsM ? rmsM[1].match(roomCodeRe) || [] : [];
    const arrM      = block.match(/Travel\s+Agent\s+Source\s+((?:\d{2}\/\d{2}\/\d{2,4}\s*)+)/i);
    const arrDates  = arrM ? arrM[1].match(/\d{2}\/\d{2}\/\d{2,4}/g) || [] : [];
    const confM     = block.match(/Conf[\s\S]{0,8}No\.?\s+((?:4\d{8}[\s,]*)+)/i);
    const confNos   = confM ? confM[1].match(/4\d{8}/g) || [] : [];
    const pkgM      = block.match(/\bPackages\s+([\s\S]*?)(?:\bETD\b|$)/i);
    const pkgStr    = pkgM ? pkgM[1] : '';
    const pkgGroups = pkgStr.match(onePkgRe) || [];
    const guestList = extractColumnNames(block);

    for (let i = 0; i < confNos.length; i++) {
      const confNo = confNos[i];
      result[confNo] = {
        name:     guestList[i] || '',
        from:     arrDates[i]  ? normDateHotel(arrDates[i])  : '',
        till:     depDates[i]  ? normDateHotel(depDates[i])  : '',
        rooms:    1,
        roomType: paxToRoomType(adls[i] ? parseInt(adls[i],10) : 2),
        mealType: normaliseMeal(pkgGroups[i] || ''),
        viewType: normaliseView(roomCodes[i] || ''),
      };
    }
  }
  return result;
}

function extractColumnNames(block) {
  const nameHdr = block.match(/\nName\n/);
  if (!nameHdr) return [];
  const beforeName = block.substring(0, nameHdr.index);
  const lines = beforeName.split('\n');
  let dateEndIdx = -1, inDates = false;
  for (let i = 0; i < lines.length; i++) {
    const s = lines[i].trim();
    if (/^\d{2}\/\d{2}\/\d{2,4}$/.test(s)) { inDates = true; dateEndIdx = i; }
    else if (inDates && s) break;
  }
  if (dateEndIdx === -1) return [];
  return lines.slice(dateEndIdx + 1)
    .map(l => l.trim())
    .filter(l => l && !/^(2506ASKANT|Block|Grand|Total|Page\s+\d|Filter|Stay|From|Market|Colors|Sort|Membership|Preferences|Arr\.|Dep\.)/.test(l));
}

function cleanGuestName(raw) {
  return (raw || '')
    .replace(/\b\d{4,}\b/g, '')
    .replace(/\d{2}\/\d{2}\/\d{2,4}/g, '')
    .replace(/\bXXXXXX\b/gi, '')
    .replace(/\b(RAC|EML|CKIN|GGTD|DNV\w*|SNV\w*|CTV\w*|STCV\w*|RAM|RMS|MKT|SRC|ADL|CHL)\b/gi, '')
    .replace(/\s+/g,' ').trim()
    .replace(/^[^a-zA-Z\u0600-\u06FF]+|[^a-zA-Z\u0600-\u06FF]+$/g,'');
}

// ‚îÄ‚îÄ SYSTEM TEXT PARSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseSystemText(text) {
  const out = [];
  const boundary = /\b[CT]\s+(\d{5,6})\s+(\d{2}\/\d{2}\/\d{4})\s+(\d{2}\/\d{2}\/\d{4})\s+Allotment/gi;
  const matches  = [...text.matchAll(boundary)];
  for (let i = 0; i < matches.length; i++) {
    const m = matches[i];
    const [, rsv, from, till] = m;
    const rowStart = m.index + m[0].length;
    const rowEnd   = i + 1 < matches.length ? matches[i+1].index : rowStart + 2000;
    const rest = text.substring(rowStart, rowEnd);
    let guestName = '';
    const firstConfM = rest.match(/\b(4\d{8})\b/);
    if (firstConfM) {
      const afterFirst = rest.substring(rest.indexOf(firstConfM[1]) + firstConfM[1].length);
      const htlIdx2 = afterFirst.search(/Al\s+Safwah\s+Tower/i);
      if (htlIdx2 > 0) {
        let raw = afterFirst.substring(0, htlIdx2);
        raw = raw.replace(/-?\s*4\d{8}\s*-?/g,' ').replace(/^[\s\-\d]+|[\s\-\d]+$/g,'').replace(/\s+/g,' ').trim();
        guestName = raw;
      }
    }
    if (!guestName || guestName.length > 80 || /^\d+$/.test(guestName) || guestName.length < 2) guestName = `RSV ${rsv}`;
    const allConfRe = /\b(4\d{8})\b/g;
    const allConfMatches = [...rest.matchAll(allConfRe)];
    const seenConfs = new Set();
    const confNos = [];
    for (const cm of allConfMatches) {
      if (!seenConfs.has(cm[1])) { seenConfs.add(cm[1]); confNos.push(cm[1]); }
    }
    const roomMpRe = /(\d+)\s*-\s*(DBL|TPL|TRPL|QUAD|SGL|SINGLE|DOUBLE|TRIPLE|QUADRUPLE)\s*-\s*([^\n\r0-9][^\n\r]*)/gi;
    const roomSlots = [];
    for (const rm of [...rest.matchAll(roomMpRe)]) {
      const cnt  = parseInt(rm[1], 10);
      const type = normaliseRoomType(rm[2]);
      let desc = (rm[3] || '').trim();
      const afterRm = rest.substring(rm.index + rm[0].length);
      // FIX v37: afterRm starts with '\n' so split produces ["", "Sohour) ..."].
      // The old code broke on the leading empty string before ever reading the next line.
      // Fix: drop leading empty elements before slicing, so "(Iftar and\nSohour)" is joined correctly.
      const extraLines = afterRm.split('\n').filter((l, i) => i === 0 ? l.trim() !== '' : true).slice(0, 3);
      for (const line of extraLines) {
        const t = line.trim();
        if (!t) break;
        if (/^\d+\s*-\s*(DBL|TPL|TRPL|QUAD|SGL|SINGLE|DOUBLE|TRIPLE|QUADRUPLE)/i.test(t)) break;
        if (/^\d{2}\/\d{2}\/\d{4}/.test(t)) break;
        if (/^[CT]\s+\d{5,6}/.test(t)) break;
        desc += ' ' + t;
      }
      desc = desc.replace(/\s+/g, ' ').trim();
      const meal = normaliseMeal(desc);
      const view = normaliseView(desc);
      for (let s = 0; s < cnt; s++) roomSlots.push({ roomType: type, mealType: meal, viewType: view });
    }
    if (roomSlots.length === 0) roomSlots.push({ roomType:'DBL', mealType:'', viewType:'Non View' });
    if (confNos.length === 0) {
      const sl = roomSlots[0];
      out.push({ rsv, htlRsv:'', from, till, guest:guestName, rooms:roomSlots.length,
        roomType:sl.roomType, mealType:sl.mealType, viewType:sl.viewType,
        hotel:'Al Safwah Tower 3', multiRoom:roomSlots.length>1, siblingConfs:[] });
    } else {
      confNos.forEach((confNo, idx) => {
        const sl = roomSlots[idx] || roomSlots[roomSlots.length - 1];
        out.push({ rsv, htlRsv:confNo, from, till, guest:guestName, rooms:1,
          roomType:sl.roomType, mealType:sl.mealType, viewType:sl.viewType,
          hotel:'Al Safwah Tower 3', multiRoom:confNos.length>1,
          siblingConfs:confNos.filter(c => c !== confNo),
          totalRoomsInRsv:confNos.length });
      });
    }
  }
  return out;
}

// ‚îÄ‚îÄ IGNORE MISMATCH FLAGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getIgnoreFlags() {
  return {
    arrival: document.getElementById('ignoreArrival') ? document.getElementById('ignoreArrival').checked : false,
    guest:   document.getElementById('ignoreGuest')   ? document.getElementById('ignoreGuest').checked   : false,
    view:    document.getElementById('ignoreView')    ? document.getElementById('ignoreView').checked    : false,
  };
}

// Called when ignore checkboxes change ‚Äî re-renders results immediately
// without re-parsing files (fast, no file I/O)
function rerunIfHasResults() {
  if (currentResults.length) {
    // Re-build results with new ignore flags from the stored raw comparison data
    applyIgnoreFlagsAndRender();
  }
}

// ‚îÄ‚îÄ COMPARISON ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// Count field-level diffs between one system slot and one hotel record.
// Used by the smart group matcher to score candidate pairings.
function countDiffsForMatch(sys, hotel) {
  let d = 0;
  if (sys.from !== hotel.from) d++;
  if (sys.till !== hotel.till) d++;
  const sRT = normaliseRoomType(sys.roomType), hRT = normaliseRoomType(hotel.roomType);
  if (sRT && hRT && sRT !== hRT) d++;
  const sMeal = normaliseMeal(sys.mealType), hMeal = normaliseMeal(hotel.mealType);
  if (sMeal && hMeal && sMeal !== hMeal) d++;
  const sView = normaliseView(sys.viewType), hView = normaliseView(hotel.viewType);
  if (sView && hView && sView !== hView) d++;
  return d;
}

// Smart group matching (greedy best-fit).
// When an RSV has multiple conf#s (sibling rooms), the system and hotel may have
// assigned the same conf# to different room types/meals. Instead of comparing
// naively by position, we find the pairing that minimises total diffs.
//
// Returns: array of assigned hotel confNos, parallel to sysSlots[].
// e.g. sysSlots[0] should be compared to hotelRecords[assignments[0]]
function smartGroupMatch(sysSlots, hotelRecords) {
  const hotelConfs = Object.keys(hotelRecords);
  const n = sysSlots.length;
  const m = hotelConfs.length;

  // Build cost matrix: costs[i][j] = diffs between sysSlots[i] and hotelConfs[j]
  const costs = sysSlots.map(sys => hotelConfs.map(conf => countDiffsForMatch(sys, hotelRecords[conf])));

  // Greedy: repeatedly assign the (sys, hotel) pair with the fewest diffs
  const usedSys = new Set(), usedHotel = new Set();
  const assignments = new Array(n).fill(null);

  for (let iter = 0; iter < Math.min(n, m); iter++) {
    let bestCost = Infinity, bestI = -1, bestJ = -1;
    for (let i = 0; i < n; i++) {
      if (usedSys.has(i)) continue;
      for (let j = 0; j < m; j++) {
        if (usedHotel.has(j)) continue;
        if (costs[i][j] < bestCost) { bestCost = costs[i][j]; bestI = i; bestJ = j; }
      }
    }
    if (bestI === -1) break;
    assignments[bestI] = hotelConfs[bestJ];
    usedSys.add(bestI);
    usedHotel.add(bestJ);
  }

  return assignments;
}

function runComparison() {
  for (const lf of loadedFiles) {
    if (lf.type === 'hotel') {
      const parsed = parseHotelText(lf.text);
      for (const [v, d] of Object.entries(parsed)) hotelMap[v] = d;
    } else if (lf.type === 'system') {
      systemList.push(...parseSystemText(lf.text));
    }
  }
  const hp = document.getElementById('hotelPaste').value.trim();
  if (hp) Object.assign(hotelMap, parseHotelText(hp));
  const sp = document.getElementById('systemPaste').value.trim();
  if (sp) systemList.push(...parseSystemText(sp));
  if (!Object.keys(hotelMap).length && !systemList.length) {
    hotelMap   = Object.assign({}, HOTEL_DATA);
    systemList = SYSTEM_DATA.map(r => Object.assign({}, r));
  }

  const results = [];
  const matchedHotelConfs = new Set();

  // ‚îÄ‚îÄ Group system entries by RSV# so we can do smart group matching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // RSVs with a single conf# go through the normal path.
  // RSVs with multiple conf#s (sibling rooms) get smart-matched as a group.
  const rsvGroups = {};
  for (const sys of systemList) {
    const rsv = sys.rsv;
    if (!rsvGroups[rsv]) rsvGroups[rsv] = [];
    rsvGroups[rsv].push(sys);
  }

  for (const [rsv, slots] of Object.entries(rsvGroups)) {
    // Collect all hotel conf#s that exist in hotelMap for this group
    const groupHotelConfs = {};
    for (const slot of slots) {
      if (slot.htlRsv && hotelMap[slot.htlRsv]) {
        groupHotelConfs[slot.htlRsv] = hotelMap[slot.htlRsv];
      }
    }

    // ‚îÄ‚îÄ Multi-room RSV: run smart group matching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (slots.length > 1 && Object.keys(groupHotelConfs).length > 1) {
      // Only smart-match slots that have a hotel conf# available
      const matchableSlots   = slots.filter(s => s.htlRsv && groupHotelConfs[s.htlRsv]);
      const unmatchableSlots = slots.filter(s => !s.htlRsv || !groupHotelConfs[s.htlRsv]);

      // Run smart matching on the matchable subset
      const assignments = smartGroupMatch(matchableSlots, groupHotelConfs);

      matchableSlots.forEach((sys, i) => {
        const assignedConf = assignments[i];
        if (!assignedConf) {
          results.push({ status:'nohotel', sys, hotel:null, diffs:[] });
          return;
        }
        const h = groupHotelConfs[assignedConf];
        matchedHotelConfs.add(assignedConf);

        // Build a synthetic sys record pointing to the best-matched hotel conf#
        // so the UI shows the correct pairing (not the original conf# assignment)
        const sysMapped = { ...sys, htlRsv: assignedConf, _origHtlRsv: sys.htlRsv };

        const diffs = [];
        if (sys.from !== h.from) diffs.push({f:'Arrival',   sv:sys.from,     hv:h.from});
        if (sys.till !== h.till) diffs.push({f:'Departure', sv:sys.till,     hv:h.till});
        const sGuest = (sys.guest||'').replace(/\s+/g,' ').trim();
        const hGuest = (h.name||'').replace(/\s+/g,' ').trim();
        if (sGuest && hGuest && !guestNamesMatch(sGuest, hGuest)) diffs.push({f:'Guest Name', sv:sys.guest, hv:h.name});
        if (sys.rooms !== h.rooms) diffs.push({f:'Room Qty', sv:sys.rooms, hv:h.rooms});
        const sRT = normaliseRoomType(sys.roomType), hRT = normaliseRoomType(h.roomType);
        if (sRT && hRT && sRT !== hRT) diffs.push({f:'Room Type', sv:sys.roomType, hv:h.roomType});
        const sMeal = normaliseMeal(sys.mealType), hMeal = normaliseMeal(h.mealType);
        if (sMeal && hMeal && sMeal !== hMeal) diffs.push({f:'Meal Plan', sv:sys.mealType, hv:h.mealType});
        const sView = normaliseView(sys.viewType), hView = normaliseView(h.viewType);
        if (sView && hView && sView !== hView) diffs.push({f:'View Type', sv:sys.viewType, hv:h.viewType});
        const groupWarning = isGroupName(sGuest) || isGroupName(hGuest);
        results.push({ status: diffs.length ? 'diff' : 'match', sys: sysMapped, hotel:h, diffs, _allDiffs: diffs.slice(), groupWarning });
      });

      // Unmatchable slots (no hotel conf#) ‚Üí nohotel
      for (const sys of unmatchableSlots) {
        results.push({ status:'nohotel', sys, hotel:null, diffs:[] });
      }

    } else {
      // ‚îÄ‚îÄ Single-room RSV or only one hotel conf# found: normal path ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      for (const sys of slots) {
        const key = sys.htlRsv;
        if (!key) { results.push({ status:'nohotel', sys, hotel:null, diffs:[] }); continue; }
        const h = hotelMap[key];
        if (!h) {
          results.push({ status:'nohotel', sys, hotel:null, diffs:[] });
        } else {
          matchedHotelConfs.add(key);
          const diffs = [];
          if (sys.from !== h.from) diffs.push({f:'Arrival',   sv:sys.from,     hv:h.from});
          if (sys.till !== h.till) diffs.push({f:'Departure', sv:sys.till,     hv:h.till});
          const sGuest = (sys.guest||'').replace(/\s+/g,' ').trim();
          const hGuest = (h.name||'').replace(/\s+/g,' ').trim();
          if (sGuest && hGuest && !guestNamesMatch(sGuest, hGuest)) diffs.push({f:'Guest Name', sv:sys.guest, hv:h.name});
          if (sys.rooms !== h.rooms) diffs.push({f:'Room Qty', sv:sys.rooms, hv:h.rooms});
          const sRT = normaliseRoomType(sys.roomType), hRT = normaliseRoomType(h.roomType);
          if (sRT && hRT && sRT !== hRT) diffs.push({f:'Room Type', sv:sys.roomType, hv:h.roomType});
          const sMeal = normaliseMeal(sys.mealType), hMeal = normaliseMeal(h.mealType);
          if (sMeal && hMeal && sMeal !== hMeal) diffs.push({f:'Meal Plan', sv:sys.mealType, hv:h.mealType});
          const sView = normaliseView(sys.viewType), hView = normaliseView(h.viewType);
          if (sView && hView && sView !== hView) diffs.push({f:'View Type', sv:sys.viewType, hv:h.viewType});
          const groupWarning = isGroupName(sGuest) || isGroupName(hGuest);
          results.push({ status: diffs.length ? 'diff' : 'match', sys, hotel:h, diffs, _allDiffs: diffs.slice(), groupWarning });
        }
      }
    }
  }

  for (const [confNo, h] of Object.entries(hotelMap)) {
    if (!matchedHotelConfs.has(confNo)) {
      const groupWarning = isGroupName(h.name||'');
      results.push({ status:'nosys', rsv:confNo, hotel:h, sys:null, diffs:[], groupWarning });
    }
  }
  rawResults     = results;
  currentFilter  = 'all';
  currentSearch  = '';
  applyIgnoreFlagsAndRender();
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderResults() {
  const el = document.getElementById('results');
  const all = currentResults;
  if (!all.length) { el.innerHTML=''; return; }
  const matched = all.filter(r=>r.status==='match');
  const diffs   = all.filter(r=>r.status==='diff');
  const nohotel = all.filter(r=>r.status==='nohotel');
  const nosys   = all.filter(r=>r.status==='nosys');
  let filtered = all;
  if (currentFilter==='match')   filtered = matched;
  if (currentFilter==='diff')    filtered = diffs;
  if (currentFilter==='nohotel') filtered = nohotel;
  if (currentFilter==='nosys')   filtered = nosys;
  const diffSummary    = diffs.map(r=>`#${r.sys.rsv} ${r.sys.guest}: ${r.diffs.map(d=>`${d.f}: System=${d.sv} vs Hotel=${d.hv}`).join(' | ')}`).join('\n');
  const nohotelSummary = nohotel.map(r=>`#${r.sys.rsv} ${r.sys.guest}`).join(', ');
  const nosysSummary   = nosys.map(r=>`#${r.rsv} ${r.hotel.name}`).join(', ');
  const statCls = s => currentFilter===s ? 'active-stat' : '';
  let html = `
  <div class="results-hdr"><div class="results-title">// ${all.filter(r=>r.status!=='nosys').length} ${currentLang==='ar'?'ÿ≠ÿ¨ÿ≤ ŸÜÿ∏ÿßŸÖ ŸÖŸÇÿßÿ®ŸÑ':'system RSVs vs'} ${Object.keys(hotelMap).length} ${currentLang==='ar'?'ŸÇÿ≥ŸäŸÖÿ© ŸÅŸÜÿØŸÇ':'hotel vouchers'}</div></div>
  <div class="stats">
    <div class="stat s-total ${statCls('all')}" onclick="setFilter('all')"><div class="num">${all.length}</div><div class="lbl">${currentLang==='ar'?'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä':'Total'}</div></div>
    <div class="stat s-match ${statCls('match')}" onclick="setFilter('match')"><div class="num">${matched.length}</div><div class="lbl">${currentLang==='ar'?'ŸÖÿ™ÿ∑ÿßÿ®ŸÇ':'Matched'}</div></div>
    <div class="stat s-diff ${statCls('diff')}" onclick="setFilter('diff')"><div class="num">${diffs.length}</div><div class="lbl">${currentLang==='ar'?'ŸÅÿ±ŸàŸÇÿßÿ™':'Differences'}</div></div>
    <div class="stat s-nohotel ${statCls('nohotel')}" onclick="setFilter('nohotel')"><div class="num">${nohotel.length}</div><div class="lbl">${currentLang==='ar'?'ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅŸÜÿØŸÇ':'Not in Hotel'}</div></div>
    <div class="stat s-nosys ${statCls('nosys')}" onclick="setFilter('nosys')"><div class="num">${nosys.length}</div><div class="lbl">${currentLang==='ar'?'ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÜÿ∏ÿßŸÖ':'Not in System'}</div></div>
  </div>`;
  if (diffs.length||nohotel.length||nosys.length) {
    html += `<div style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px;">`;
    if (diffs.length)   html += `<span class="mismatch-chip" onclick="copyText(${JSON.stringify(diffSummary)},this)">‚ö† ${diffs.length} Difference${diffs.length>1?'s':''}: ${diffs.map(r=>`#${r.sys.rsv} [${r.diffs.map(d=>d.f).join(',')}]`).join(' ¬∑ ')} <span class="copy-icon">‚ßâ</span></span>`;
    if (nohotel.length) html += `<span class="mismatch-chip" style="border-color:rgba(255,71,87,.3);background:rgba(255,71,87,.07);color:var(--red);" onclick="copyText(${JSON.stringify('NOT IN HOTEL: '+nohotelSummary)},this)">‚úó ${nohotel.length} Not in Hotel: ${nohotel.map(r=>`#${r.sys.rsv}`).join(' ¬∑ ')} <span class="copy-icon">‚ßâ</span></span>`;
    if (nosys.length)   html += `<span class="mismatch-chip" style="border-color:rgba(179,136,255,.3);background:rgba(179,136,255,.07);color:var(--purple);" onclick="copyText(${JSON.stringify('NOT IN SYSTEM: '+nosysSummary)},this)">‚óà ${nosys.length} Not in System: ${nosys.map(r=>`#${r.rsv}`).join(' ¬∑ ')} <span class="copy-icon">‚ßâ</span></span>`;
    html += `</div>`;
  }
  html += `<div class="export-bar">
    <div class="export-bar-row">
      <span class="export-bar-label">Export:</span>
      <button class="export-btn" onclick="exportText()">üìÑ Text Report</button>
      <button class="export-btn excel" onclick="exportExcel()">üìä Excel</button>
      <button class="export-btn img" onclick="exportImage()">üñº Image</button>
    </div>
    <div class="export-sections-row">
      <span class="export-sections-label">Include:</span>
      <label class="export-chk-group chk-match"><input type="checkbox" id="chkMatch" checked><span class="chk-box"></span><span class="chk-label" style="color:var(--green)">Matched</span></label>
      <label class="export-chk-group chk-nohotel"><input type="checkbox" id="chkNoHotel" checked><span class="chk-box"></span><span class="chk-label" style="color:var(--red)">Not in Hotel</span></label>
      <label class="export-chk-group chk-nosys"><input type="checkbox" id="chkNoSys" checked><span class="chk-box"></span><span class="chk-label" style="color:var(--purple)">Not in System</span></label>
      <label class="export-chk-group chk-diff"><input type="checkbox" id="chkDiff" checked><span class="chk-box"></span><span class="chk-label" style="color:var(--yellow)">Differences</span></label>
    </div>
  </div>`;
  html += `<input class="search-box" id="searchBox" type="text" placeholder="${currentLang==='ar'?'ÿßÿ®ÿ≠ÿ´ ÿ®ÿ±ŸÇŸÖ ÿßŸÑÿ≠ÿ¨ÿ≤ ÿ£Ÿà ÿßÿ≥ŸÖ ÿßŸÑÿ∂ŸäŸÅ...':'Search by RSV# or guest name...'}" value="${currentSearch}" oninput="handleSearch(this.value)">
  <div class="search-count" id="searchCount"></div>`;
  const groups = [
    {s:'diff',    items:filtered.filter(r=>r.status==='diff'),    label: currentLang==='ar' ? 'ŸÅÿ±ŸàŸÇÿßÿ™ ŸÖŸàÿ¨ŸàÿØÿ©'              : 'Differences Found',        dot:'sd-diff'},
    {s:'nohotel', items:filtered.filter(r=>r.status==='nohotel'), label: currentLang==='ar' ? 'ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ ¬∑ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅŸÜÿØŸÇ' : 'In System ¬∑ Not in Hotel', dot:'sd-nohotel'},
    {s:'nosys',   items:filtered.filter(r=>r.status==='nosys'),   label: currentLang==='ar' ? 'ŸÅŸä ÿßŸÑŸÅŸÜÿØŸÇ ¬∑ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÜÿ∏ÿßŸÖ' : 'In Hotel ¬∑ Not in System', dot:'sd-nosys'},
    {s:'match',   items:filtered.filter(r=>r.status==='match'),   label: currentLang==='ar' ? 'ŸÖÿ™ÿ∑ÿßÿ®ŸÇ'                      : 'Matched',                  dot:'sd-match'},
  ];
  for (const g of groups) {
    if (!g.items.length) continue;
    html += `<div class="section-hdr"><div class="sdot ${g.dot}"></div><h3>${g.label} (${g.items.length})</h3></div>`;
    for (const r of g.items) html += buildItem(r);
  }
  el.innerHTML = html;
  if (currentSearch) handleSearch(currentSearch, false);
}

function buildItem(r) {
  const ar = currentLang === 'ar';
  const bm = {match:'bd-match',diff:'bd-diff',nohotel:'bd-nohotel',nosys:'bd-nosys'};
  const bt = {
    match:   ar ? '‚úì ŸÖÿ™ÿ∑ÿßÿ®ŸÇ'          : '‚úì MATCH',
    diff:    ar ? '‚ö† ŸÅÿ±ŸàŸÇ'            : '‚ö† DIFF',
    nohotel: ar ? '‚úó ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÅŸÜÿØŸÇ' : '‚úó NOT IN HOTEL',
    nosys:   ar ? '‚óà ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ÿ®ÿßŸÑŸÜÿ∏ÿßŸÖ' : '‚óà NOT IN SYSTEM',
  };
  const fieldNames = {
    'Arrival':    ar ? 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàÿµŸàŸÑ'  : 'Arrival',
    'Departure':  ar ? 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖÿ∫ÿßÿØÿ±ÿ©' : 'Departure',
    'Guest Name': ar ? 'ÿßÿ≥ŸÖ ÿßŸÑÿ∂ŸäŸÅ'     : 'Guest Name',
    'Room Qty':   ar ? 'ÿπÿØÿØ ÿßŸÑÿ∫ÿ±ŸÅ'     : 'Room Qty',
    'Room Type':  ar ? 'ŸÜŸàÿπ ÿßŸÑÿ∫ÿ±ŸÅÿ©'    : 'Room Type',
    'Meal Plan':  ar ? 'ÿÆÿ∑ÿ© ÿßŸÑŸàÿ¨ÿ®ÿßÿ™'   : 'Meal Plan',
    'View Type':  ar ? 'ŸÜŸàÿπ ÿßŸÑÿ•ÿ∑ŸÑÿßŸÑÿ©'  : 'View Type',
  };
  const htlConfNo = r.status==='nosys' ? r.rsv : (r.sys ? r.sys.htlRsv || r.sys.rsv : r.rsv);
  const sysRsvNo  = r.sys ? r.sys.rsv : '';
  const rsv       = htlConfNo;
  const guest     = r.status==='nosys' ? (r.hotel.name||r.rsv) : r.sys.guest;
  const htlId     = sysRsvNo ? `SYS#${sysRsvNo}` : '';
  const isMulti   = r.sys && r.sys.multiRoom;
  const siblings  = r.sys && r.sys.siblingConfs ? r.sys.siblingConfs : [];
  const totalInRsv= r.sys && r.sys.totalRoomsInRsv ? r.sys.totalRoomsInRsv : 1;
  const multiTag  = isMulti
    ? `<span style="font-size:0.62rem;background:rgba(90,96,128,0.12);border:1px solid rgba(90,96,128,0.30);border-radius:5px;padding:2px 6px;color:var(--accent-mid);font-family:'IBM Plex Mono',monospace;white-space:nowrap;" title="${ar?`ÿ¨ÿ≤ÿ° ŸÖŸÜ ÿ≠ÿ¨ÿ≤ ${totalInRsv} ÿ∫ÿ±ŸÅ (SYS#${sysRsvNo})`:`Part of a ${totalInRsv}-room reservation (SYS#${sysRsvNo})`}">üè†√ó${totalInRsv}</span>` : '';
  const groupChip = r.groupWarning
    ? `<span style="font-size:0.62rem;background:rgba(255,152,0,0.15);border:1px solid rgba(255,152,0,0.45);border-radius:5px;padding:2px 7px;color:#ff9800;font-family:'IBM Plex Mono',monospace;white-space:nowrap;flex-shrink:0;">‚ö† ${ar?'ÿ≠ÿ¨ÿ≤ ÿ¨ŸÖÿßÿπŸä ‚Äî ÿ±ÿßÿ¨ÿπ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∫ÿ±ŸÅ':'GROUP ‚Äî CHECK ROOMING LIST'}</span>`
    : '';
  let mismatchSummary = '';
  if (r.status==='diff' && r.diffs.length) {
    const txt = r.diffs.map(d=>`${fieldNames[d.f]||d.f}: ${d.sv}‚Üí${d.hv}`).join(' | ');
    mismatchSummary = `<span class="mismatch-chip" style="font-size:0.62rem;padding:2px 7px;" onclick="event.stopPropagation();copyText(${JSON.stringify(txt)},this)">${txt} <span class="copy-icon">‚ßâ</span></span>`;
  }
  let body = '';
  if (r.status==='nohotel') {
    const siblingsInfo = siblings.length ? `<br><span style="color:var(--muted);font-size:0.75rem;">${ar?'ÿ∫ÿ±ŸÅ ŸÖÿ±ÿ™ÿ®ÿ∑ÿ© ŸÅŸä ŸÜŸÅÿ≥ ÿßŸÑÿ≠ÿ¨ÿ≤:':'Sibling rooms in same RSV:'} ${siblings.join(', ')}</span>` : '';
    body = `<div class="alert-msg red">‚ö† ${ar?`ÿ±ŸÇŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑŸÅŸÜÿØŸÇ ${rsv} ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ (SYS# ${sysRsvNo}) ŸÑŸÉŸÜŸá ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ŸÖŸÑŸÅ ÿßŸÑŸÅŸÜÿØŸÇ.`:`Hotel Conf# ${rsv} is in the System (SYS# ${sysRsvNo}) but NOT FOUND in the Hotel file.`}<br>${ar?'ÿßŸÑŸÜÿ∏ÿßŸÖ':'System'}: ${r.sys.from} ‚Üê ${r.sys.till} | ${r.sys.roomType} | ${r.sys.mealType} | ${r.sys.viewType}${siblingsInfo}</div>`;
  } else if (r.status==='nosys') {
    body = `<div class="alert-msg purple">‚óà ${ar?`ÿ±ŸÇŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑŸÅŸÜÿØŸÇ ${rsv} ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑŸÅŸÜÿØŸÇ ŸÑŸÉŸÜŸá ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ.`:`Hotel Conf# ${rsv} is in the Hotel file but NOT FOUND in the System.`}<br>${ar?'ÿßŸÑŸÅŸÜÿØŸÇ':'Hotel'}: ${r.hotel.from} ‚Üê ${r.hotel.till} | ${r.hotel.roomType} | ${r.hotel.mealType} | ${r.hotel.viewType}</div>`;
  } else {
    const siblingRow = isMulti && siblings.length
      ? `<tr><td style="color:var(--muted);font-family:'IBM Plex Mono',monospace;font-size:.7rem">${ar?'ÿ∫ÿ±ŸÅ ŸÖÿ±ÿ™ÿ®ÿ∑ÿ©':'Sibling Rooms'}</td><td colspan="3" style="font-family:'IBM Plex Mono',monospace;font-size:.72rem;color:var(--muted)">${siblings.join(' ¬∑ ')} (${totalInRsv} ${ar?'ÿ∫ÿ±ŸÅ ŸÅŸä':'rooms total in'} SYS#${sysRsvNo})</td></tr>` : '';
    body = `<table class="ctbl"><thead><tr><th>${ar?'ÿßŸÑÿ≠ŸÇŸÑ':'Field'}</th><th>${ar?'ÿßŸÑŸÜÿ∏ÿßŸÖ':'System'}</th><th>${ar?'ÿßŸÑŸÅŸÜÿØŸÇ':'Hotel'}</th><th>${ar?'ÿßŸÑÿ≠ÿßŸÑÿ©':'Status'}</th></tr></thead><tbody>`;
    const rows7 = [
      {f:'Arrival',    sv:r.sys.from,     hv:r.hotel.from,     cmp:(a,b)=>a===b},
      {f:'Departure',  sv:r.sys.till,     hv:r.hotel.till,     cmp:(a,b)=>a===b},
      {f:'Guest Name', sv:r.sys.guest,    hv:r.hotel.name,     cmp:(a,b)=>guestNamesMatch(a||'',b||'')},
      {f:'Room Qty',   sv:r.sys.rooms,    hv:r.hotel.rooms,    cmp:(a,b)=>String(a)===String(b)},
      {f:'Room Type',  sv:r.sys.roomType, hv:r.hotel.roomType, cmp:(a,b)=>normaliseRoomType(a)===normaliseRoomType(b)},
      {f:'Meal Plan',  sv:r.sys.mealType, hv:r.hotel.mealType, cmp:(a,b)=>normaliseMeal(a)===normaliseMeal(b)},
      {f:'View Type',  sv:r.sys.viewType, hv:r.hotel.viewType, cmp:(a,b)=>normaliseView(a)===normaliseView(b)},
    ];
    for (const {f,sv,hv,cmp} of rows7) {
      const ok = cmp(sv,hv);
      body += `<tr><td style="color:var(--muted);font-family:'IBM Plex Mono',monospace;font-size:.7rem">${fieldNames[f]||f}</td><td class="${ok?'v-ok':'v-diff'}">${sv??''}</td><td class="${ok?'v-ok':'v-diff'}">${hv??''}</td><td>${ok?'<span style="color:var(--green)">‚úì</span>':`<span style="color:var(--yellow)">‚ö† ${ar?'ÿ™ÿπÿßÿ±ÿ∂':'MISMATCH'}</span>`}</td></tr>`;
    }
    body += siblingRow + '</tbody></table>';
    if (r.hotel && r.hotel.name) body += `<div class="meta-row">${ar?'ÿßÿ≥ŸÖ ÿßŸÑÿ∂ŸäŸÅ (ÿßŸÑŸÅŸÜÿØŸÇ)':'Guest Name (Hotel)'}: <span>${r.hotel.name}</span></div>`;
  }
  if (r.groupWarning) {
    body += `<div class="group-warning-banner">üìã ${ar?'ÿ≠ÿ¨ÿ≤ ÿ¨ŸÖÿßÿπŸä ‚Äî Ÿäÿ±ÿ¨Ÿâ ŸÖÿ±ÿßÿ¨ÿπÿ© ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ∫ÿ±ŸÅ ŸÑŸÑÿßÿ∑ŸÑÿßÿπ ÿπŸÑŸâ ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑÿ∂ŸäŸàŸÅ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ Ÿàÿ™Ÿàÿ≤Ÿäÿπ ÿßŸÑÿ∫ÿ±ŸÅ.':'GROUP RESERVATION ‚Äî Please check the rooming list for individual guest names and room assignments.'}</div>`;
  }
  if (htlId) body += `<div class="meta-row">${ar?'ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ':'Confirmation'}: <span>${htlId}</span></div>`;
  return `<div class="result-item st-${r.status}" data-rsv="${rsv}" data-sysrsv="${sysRsvNo}" data-name="${guest.toLowerCase()}">
    <div class="result-header" onclick="this.parentElement.classList.toggle('open')">
      <div class="rsv-num" title="${ar?'ÿ±ŸÇŸÖ ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑŸÅŸÜÿØŸÇ':'Hotel Conf#'}">#${rsv}</div>
      <button class="rsv-copy-btn" onclick="copyRsvNum(event,'${rsv}')" title="${ar?'ŸÜÿ≥ÿÆ ÿ±ŸÇŸÖ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ':'Copy hotel conf number'}">‚éò</button>
      <div class="guest-name">${guest}</div>
      ${multiTag}
      ${groupChip}
      ${mismatchSummary}
      <div class="htl-tag">${htlId}</div>
      <span class="badge ${bm[r.status]}">${bt[r.status]}</span>
      <span class="chevron">‚ñº</span>
    </div>
    <div class="result-body">${body}</div>
  </div>`;
}

function copyRsvNum(e, num) {
  e.stopPropagation();
  const btn = e.currentTarget;
  navigator.clipboard.writeText(num).catch(()=>{}).finally(()=>{
    btn.textContent='‚úì'; btn.classList.add('copied');
    setTimeout(()=>{ btn.textContent='‚éò'; btn.classList.remove('copied'); }, 1500);
  });
}

function setFilter(f) { currentFilter=f; renderResults(); }

function handleSearch(v, updateState=true) {
  if (updateState) currentSearch = v;
  v = v.toLowerCase();
  const items = document.querySelectorAll('.result-item');
  let visible = 0;
  items.forEach(el => {
    const show = !v || (el.dataset.rsv||'').includes(v) || (el.dataset.sysrsv||'').includes(v) || (el.dataset.name||'').includes(v);
    el.style.display = show ? '' : 'none';
    if (show) visible++;
  });
  const countEl = document.getElementById('searchCount');
  if (countEl) {
    if (v) { countEl.textContent=currentLang==='ar'?`${visible} ŸÜÿ™Ÿäÿ¨ÿ© ŸÑŸÑÿ®ÿ≠ÿ´ ÿπŸÜ "${v}"` : `${visible} result${visible!==1?'s':''} matching "${v}"`; countEl.classList.add('visible'); }
    else countEl.classList.remove('visible');
  }
  document.querySelectorAll('.section-hdr').forEach(hdr => {
    let next = hdr.nextElementSibling; let anyVisible = false;
    while (next && next.classList.contains('result-item')) {
      if (next.style.display !== 'none') anyVisible = true;
      next = next.nextElementSibling;
    }
    hdr.style.display = anyVisible ? '' : 'none';
  });
}

function copyText(txt, el) {
  navigator.clipboard.writeText(txt).then(() => {
    const orig = el.innerHTML;
    el.innerHTML = el.innerHTML.replace('‚ßâ','‚úì Copied!');
    setTimeout(()=>{ el.innerHTML = orig; }, 1500);
  }).catch(()=> toast('Copy failed ‚Äî please copy manually'));
}

function getExportSections() {
  return {
    matched: document.getElementById('chkMatch')   ? document.getElementById('chkMatch').checked   : true,
    nohotel: document.getElementById('chkNoHotel') ? document.getElementById('chkNoHotel').checked : true,
    nosys:   document.getElementById('chkNoSys')   ? document.getElementById('chkNoSys').checked   : true,
    diffs:   document.getElementById('chkDiff')    ? document.getElementById('chkDiff').checked    : true,
  };
}

function buildReportText() {
  const all=currentResults; const diffs=all.filter(r=>r.status==='diff');
  const nohotel=all.filter(r=>r.status==='nohotel'); const nosys=all.filter(r=>r.status==='nosys');
  const matched=all.filter(r=>r.status==='match'); const now=new Date().toLocaleString(); const sel=getExportSections();
  let txt=`RESERVATION COMPARISON REPORT\nGenerated: ${now}\n${'='.repeat(60)}\n\nSUMMARY\n${'-'.repeat(40)}\nTotal Entries  : ${all.length}\n`;
  if(sel.matched) txt+=`Matched        : ${matched.length}\n`;
  if(sel.diffs)   txt+=`Differences    : ${diffs.length}\n`;
  if(sel.nohotel) txt+=`Not in Hotel   : ${nohotel.length}\n`;
  if(sel.nosys)   txt+=`Not in System  : ${nosys.length}\n`;
  txt+='\n';
  if(sel.diffs&&diffs.length){txt+=`DIFFERENCES (${diffs.length})\n${'-'.repeat(40)}\n`;diffs.forEach(r=>{txt+=`Conf# ${r.sys.htlRsv||r.sys.rsv} ‚Äî ${r.sys.guest} [SYS#${r.sys.rsv}]\n`;r.diffs.forEach(d=>txt+=`  ‚Ä¢ ${d.f}: System="${d.sv}" vs Hotel="${d.hv}"\n`);txt+='\n';});}
  if(sel.nohotel&&nohotel.length){txt+=`IN SYSTEM ¬∑ NOT IN HOTEL (${nohotel.length})\n${'-'.repeat(40)}\n`;nohotel.forEach(r=>txt+=`  Conf# ${r.sys.htlRsv||r.sys.rsv} ‚Äî ${r.sys.guest} | ${r.sys.from}‚Üí${r.sys.till}\n`);txt+='\n';}
  if(sel.nosys&&nosys.length){txt+=`IN HOTEL ¬∑ NOT IN SYSTEM (${nosys.length})\n${'-'.repeat(40)}\n`;nosys.forEach(r=>txt+=`  Conf# ${r.rsv} ‚Äî ${r.hotel.name||''} | ${r.hotel.from}‚Üí${r.hotel.till}\n`);txt+='\n';}
  if(sel.matched&&matched.length){txt+=`MATCHED (${matched.length})\n${'-'.repeat(40)}\n`;matched.forEach(r=>txt+=`  RSV# ${r.sys.rsv} ‚Äî ${r.sys.guest}\n`);}
  return txt;
}

function exportText() {
  const blob=new Blob([buildReportText()],{type:'text/plain'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download=`Comparison_Report_${new Date().toISOString().slice(0,10)}.txt`; a.click();
  toast('Text report downloaded');
}

function exportExcel() {
  const all=currentResults; const now=new Date().toLocaleString(); const sel=getExportSections();
  const exportRows=all.filter(r=>{
    if(r.status==='match'   && !sel.matched) return false;
    if(r.status==='diff'    && !sel.diffs)   return false;
    if(r.status==='nohotel' && !sel.nohotel) return false;
    if(r.status==='nosys'   && !sel.nosys)   return false;
    return true;
  });
  function doXlsx(XLSX) {
    const wb=XLSX.utils.book_new();
    const matched=all.filter(r=>r.status==='match'); const diffs=all.filter(r=>r.status==='diff');
    const nohotel=all.filter(r=>r.status==='nohotel'); const nosys=all.filter(r=>r.status==='nosys');
    const summaryRows=[['Reservation Comparison Report'],[`Generated: ${now}`],[],['SUMMARY',''],['Total Entries',all.length]];
    if(sel.matched) summaryRows.push(['Matched',matched.length]);
    if(sel.diffs)   summaryRows.push(['Differences',diffs.length]);
    if(sel.nohotel) summaryRows.push(['Not in Hotel',nohotel.length]);
    if(sel.nosys)   summaryRows.push(['Not in System',nosys.length]);
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(summaryRows),'Summary');
    const headers=['Hotel Conf#','SYS RSV#','Guest Name (System)','Guest Name (Hotel)','Status','Group Warning','Arrival (System)','Arrival (Hotel)','Departure (System)','Departure (Hotel)','Room Type (System)','Room Type (Hotel)','Meal Plan (System)','Meal Plan (Hotel)','View Type (System)','View Type (Hotel)','Diff Fields'];
    const dataRows=[headers];
    exportRows.forEach(r=>{
      const htlConf=r.status==='nosys'?r.rsv:(r.sys?r.sys.htlRsv||r.sys.rsv:r.rsv);
      const sysRsv=r.sys?r.sys.rsv:'';
      const guest=r.sys?r.sys.guest:(r.hotel?r.hotel.name:'');
      const hGuest=r.hotel?r.hotel.name:'';
      const status={match:'MATCH',diff:'DIFF',nohotel:'NOT IN HOTEL',nosys:'NOT IN SYSTEM'}[r.status];
      const groupWarn=r.groupWarning?'CHECK ROOMING LIST':'';
      const diffFlds=r.diffs?r.diffs.map(d=>d.f).join('; '):'';
      dataRows.push([htlConf,sysRsv,guest,hGuest,status,groupWarn,r.sys?r.sys.from:'',r.hotel?r.hotel.from:'',r.sys?r.sys.till:'',r.hotel?r.hotel.till:'',r.sys?r.sys.roomType:'',r.hotel?r.hotel.roomType:'',r.sys?r.sys.mealType:'',r.hotel?r.hotel.mealType:'',r.sys?r.sys.viewType:'',r.hotel?r.hotel.viewType:'',diffFlds]);
    });
    const wsData=XLSX.utils.aoa_to_sheet(dataRows);
    wsData['!cols']=[14,12,30,30,16,22,14,14,14,14,14,14,18,18,14,14,20].map(w=>({wch:w}));
    XLSX.utils.book_append_sheet(wb,wsData,'Reservations');
    XLSX.writeFile(wb,`Comparison_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
    toast('Excel report downloaded');
  }
  if(window.XLSX){doXlsx(window.XLSX);}
  else{const s=document.createElement('script');s.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';s.onload=()=>doXlsx(window.XLSX);s.onerror=()=>toast('Could not load XLSX library.');document.head.appendChild(s);}
}

function exportImage() {
  const all=currentResults; const diffs=all.filter(r=>r.status==='diff');
  const nohotel=all.filter(r=>r.status==='nohotel'); const nosys=all.filter(r=>r.status==='nosys');
  const matched=all.filter(r=>r.status==='match'); const sel=getExportSections();
  const canvas=document.createElement('canvas'); const scale=2; const W=900,rowH=28,pad=28;
  const headerH=180,summaryH=130;
  const diffH=sel.diffs&&diffs.length?50+diffs.length*50:0;
  const nhH=sel.nohotel&&nohotel.length?40+nohotel.length*rowH:0;
  const nsH=sel.nosys&&nosys.length?40+nosys.length*rowH:0;
  const matchH=sel.matched&&matched.length?40+matched.length*rowH:0;
  const totalH=headerH+summaryH+diffH+nhH+nsH+matchH+pad*3;
  canvas.width=W*scale; canvas.height=totalH*scale;
  const ctx=canvas.getContext('2d'); ctx.scale(scale,scale);
  ctx.fillStyle='#07090f'; ctx.fillRect(0,0,W,totalH);
  ctx.fillStyle='#0f1623'; ctx.fillRect(0,0,W,headerH-10);
  ctx.font='bold 22px IBM Plex Sans,sans-serif'; ctx.fillStyle='#ffffff'; ctx.fillText('Reservation',pad,45);
  ctx.fillStyle='#00c8ff'; ctx.fillText('Comparison',pad+150,45);
  ctx.fillStyle='#ffffff'; ctx.fillText('Report',pad+304,45);
  ctx.font='12px IBM Plex Mono,monospace'; ctx.fillStyle='#5a7490';
  ctx.fillText(`Generated: ${new Date().toLocaleString()}`,pad,68);
  const stats=[{label:'TOTAL',val:all.length,color:'#00c8ff'},{label:'MATCHED',val:matched.length,color:'#00e676'},{label:'DIFFERENCES',val:diffs.length,color:'#ffd600'},{label:'NOT IN HOTEL',val:nohotel.length,color:'#ff4757'},{label:'NOT IN SYS',val:nosys.length,color:'#b388ff'}];
  const bW=(W-pad*2-8*4)/5;
  stats.forEach((s,i)=>{const x=pad+i*(bW+8),y=headerH;ctx.fillStyle='#0f1623';ctx.strokeStyle='#243347';roundRect(ctx,x,y,bW,80,8);ctx.fill();ctx.stroke();ctx.font='bold 28px IBM Plex Mono,monospace';ctx.fillStyle=s.color;ctx.textAlign='center';ctx.fillText(s.val,x+bW/2,y+42);ctx.font='9px IBM Plex Mono,monospace';ctx.fillStyle='#5a7490';ctx.fillText(s.label,x+bW/2,y+60);ctx.textAlign='left';});
  let y=headerH+summaryH;
  function sectionHeader(label,color){ctx.fillStyle=color;ctx.fillRect(pad,y+6,6,6);ctx.font='bold 11px IBM Plex Mono,monospace';ctx.fillStyle='#5a7490';ctx.fillText(label.toUpperCase(),pad+14,y+15);ctx.strokeStyle='#243347';ctx.beginPath();ctx.moveTo(pad,y+22);ctx.lineTo(W-pad,y+22);ctx.stroke();y+=32;}
  function tableRow(cols,colors,bold=false){ctx.font=`${bold?'bold ':''} 11px IBM Plex Mono,monospace`;const colW=[(W-pad*2)*0.12,(W-pad*2)*0.22,(W-pad*2)*0.16,(W-pad*2)*0.16,(W-pad*2)*0.16,(W-pad*2)*0.18];let x2=pad;cols.forEach((c,i)=>{ctx.fillStyle=colors[i]||'#dde6f0';ctx.fillText(String(c).substring(0,30),x2,y+14);x2+=colW[i];});y+=rowH;}
  if(sel.diffs&&diffs.length){sectionHeader(`Differences (${diffs.length})`,'#ffd600');tableRow(['RSV#','Guest','Arrival','Departure','Rooms (Sys)','Rooms (Htl)'],['#5a7490','#5a7490','#5a7490','#5a7490','#5a7490','#5a7490'],true);diffs.forEach(r=>{const rSys=r.sys.rooms,rHtl=r.hotel.rooms;tableRow([`#${r.sys.rsv}`,r.sys.guest.substring(0,22),r.sys.from,r.sys.till,rSys,rHtl],['#00c8ff','#dde6f0',r.sys.from!==r.hotel.from?'#ffd600':'#00e676',r.sys.till!==r.hotel.till?'#ffd600':'#00e676',rSys!==rHtl?'#ffd600':'#00e676',rSys!==rHtl?'#ffd600':'#00e676']);});y+=10;}
  if(sel.nohotel&&nohotel.length){sectionHeader(`Not in Hotel (${nohotel.length})`,'#ff4757');nohotel.forEach(r=>tableRow([`#${r.sys.rsv}`,r.sys.guest.substring(0,30),r.sys.from,r.sys.till,r.sys.rooms,'-'],['#00c8ff','#ff4757','#dde6f0','#dde6f0','#dde6f0','#5a7490']));y+=10;}
  if(sel.nosys&&nosys.length){sectionHeader(`Not in System (${nosys.length})`,'#b388ff');nosys.forEach(r=>tableRow([`#${r.rsv}`,r.hotel.name.substring(0,30),r.hotel.from,r.hotel.till,'-',r.hotel.rooms],['#00c8ff','#b388ff','#dde6f0','#dde6f0','#5a7490','#dde6f0']));y+=10;}
  if(sel.matched&&matched.length){sectionHeader(`Matched (${matched.length})`,'#00e676');matched.forEach(r=>tableRow([`#${r.sys.rsv}`,r.sys.guest.substring(0,30),r.sys.from,r.sys.till,r.sys.rooms,r.hotel.rooms],['#00c8ff','#dde6f0','#00e676','#00e676','#00e676','#00e676']));}
  canvas.toBlob(blob=>{const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`Comparison_Report_${new Date().toISOString().slice(0,10)}.png`;a.click();toast('Image report downloaded');});
}

function roundRect(ctx,x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+w-r,y);ctx.arcTo(x+w,y,x+w,y+r,r);ctx.lineTo(x+w,y+h-r);ctx.arcTo(x+w,y+h,x+w-r,y+h,r);ctx.lineTo(x+r,y+h);ctx.arcTo(x,y+h,x,y+h-r,r);ctx.lineTo(x,y+r);ctx.arcTo(x,y,x+r,y,r);ctx.closePath();}

function toast(msg){const t=document.createElement('div');t.style.cssText='position:fixed;bottom:22px;right:22px;background:#1a2236;border:1px solid #243347;color:#dde6f0;padding:9px 16px;border-radius:8px;font-size:0.77rem;font-family:\'IBM Plex Mono\',monospace;z-index:9999;opacity:0;transition:opacity .3s;max-width:320px;';t.textContent=msg;document.body.appendChild(t);requestAnimationFrame(()=>t.style.opacity='1');setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),300);},3000);}

let loadedFiles=[];
function guessFileType(filename){const n=filename.toLowerCase();if(/^sys[_-]?\d/.test(n)||n.includes('system')||n.includes('sys_')||n.includes('rsv')||n.includes('reservation'))return 'system';if(n.includes('hotel')||n.includes('hotal')||n.includes('voucher')||n.includes('htl')||n==='hotel.pdf')return 'hotel';return 'unknown';}
function renderFileTags(){const wrap=document.getElementById('fileTagsWrap');const inner=document.getElementById('dropInner');const tagsEl=document.getElementById('fileTags');if(!loadedFiles.length){wrap.style.display='none';inner.style.display='';return;}inner.style.display='none';wrap.style.display='';tagsEl.innerHTML=loadedFiles.map((lf,i)=>{const cls=lf.type==='hotel'?'hotel-tag':lf.type==='system'?'system-tag':'unknown-tag';const icon=lf.type==='hotel'?'üè®':lf.type==='system'?'üñ•':'‚ùì';return `<div class="file-tag ${cls}" id="ftag-${i}"><span>${icon}</span><select class="type-select" onchange="changeFileType(${i},this.value)"><option value="hotel" ${lf.type==='hotel'?'selected':''}>Hotel</option><option value="system" ${lf.type==='system'?'selected':''}>System</option></select><span class="tag-name" title="${lf.file.name}">${lf.file.name}</span><button class="tag-rm" onclick="removeLoadedFile(${i})" title="Remove">‚úï</button></div>`;}).join('');}
function changeFileType(idx,newType){if(loadedFiles[idx]){loadedFiles[idx].type=newType;renderFileTags();}}
function removeLoadedFile(idx){loadedFiles.splice(idx,1);renderFileTags();}
async function processSmartFiles(files){for(const file of files){const type=guessFileType(file.name);let text='';try{if(file.name.toLowerCase().endsWith('.pdf')){text=await extractPdfText(file);}else{text=await file.text();}}catch(e){toast('Could not read: '+file.name);continue;}let finalType=type;if(type==='unknown'){if(/al safwah hotel tower three/i.test(text)||/arrivals:\s*detailed/i.test(text)||/2506askant/i.test(text))finalType='hotel';else if(/arrival.*in house during period/i.test(text)||/askant travel.*makkah/i.test(text))finalType='system';else if(/askant travel/i.test(text)&&/\b[CT]\s+\d{5,6}\s+\d{2}\/\d{2}\/\d{4}/.test(text))finalType='system';else if(/4\d{8}/.test(text)&&/iftar ram/i.test(text))finalType='hotel';}loadedFiles.push({file,type:finalType,text});}renderFileTags();toast(`${files.length} file(s) loaded. Check types above then click Run Comparison.`);}
function initSmartDrop(){const zone=document.getElementById('smartDrop');const inp=document.getElementById('smartFileInput');zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('dragover');});zone.addEventListener('dragleave',()=>zone.classList.remove('dragover'));zone.addEventListener('drop',e=>{e.preventDefault();zone.classList.remove('dragover');if(e.dataTransfer.files.length)processSmartFiles([...e.dataTransfer.files]);});inp.addEventListener('change',e=>{if(e.target.files.length){processSmartFiles([...e.target.files]);e.target.value='';}});}

let currentLang='en';
function toggleTheme(){const html=document.getElementById('appHtml');const btn=document.getElementById('themeBtn');const isDark=html.getAttribute('data-theme')==='dark';html.setAttribute('data-theme',isDark?'light':'dark');btn.textContent=isDark?'üåô Dark Mode':'‚òÄÔ∏è Light Mode';}

// ‚îÄ‚îÄ TRANSLATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TRANSLATIONS = {
  en: {
    mainTitle:        'ALTANTAWY <span>Comparison</span> Tool',
    mainSubtitle:     'FOR AL SAFWAH TOWER 3 HOTEL',
    themeBtn:         '‚òÄÔ∏è Light Mode',
    langBtn:          'üåê ÿπÿ±ÿ®Ÿä',
    btnClear:         'üóë Clear All & Reset',
    dropTitle:        'Drop files here or <span class="drop-link" onclick="document.getElementById(\'smartFileInput\').click()">browse</span>',
    dropSub:          'Select both Hotel & System files at once ‚Äî app auto-detects type',
    dropFormats:      'PDF ¬∑ TXT ¬∑ CSV ¬∑ Multiple files supported',
    hotelCardLabel:   'Hotel File(s)',
    hotelCardTitle:   'üè® Hotel Main File',
    addHotelBtn:      'Ôºã Add Hotel File Manually',
    hotelPasteLabel:  'Or paste hotel text',
    sysCardLabel:     'System File(s)',
    sysCardTitle:     'üñ• System Files',
    addSysBtn:        'Ôºã Add System File Manually',
    sysPasteLabel:    'Or paste system text',
    compareBtn:       '‚ö° Run Comparison',
    ignorePanelTitle: 'IGNORE MISMATCH',
    ignorePanelDesc:  'Checked fields will be skipped ‚Äî results update instantly',
    ignoreArrivalLbl: 'üìÖ Arrival',
    ignoreGuestLbl:   'üë§ Guest Name',
    ignoreViewLbl:    'ü™ü View Type',
    hotelPastePh:     'Paste hotel reservation text here...',
    sysPastePh:       'Paste system reservation text here...',
  },
  ar: {
    mainTitle:        'ALTANTAWY <span>ÿ£ÿØÿßÿ© ÿßŸÑŸÖŸÇÿßÿ±ŸÜÿ©</span>',
    mainSubtitle:     'ŸÑŸÅŸÜÿØŸÇ ÿßŸÑÿµŸÅŸàÿ© ÿ™ÿßŸàÿ± 3',
    themeBtn:         '‚òÄÔ∏è ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÅÿßÿ™ÿ≠',
    langBtn:          'üåê English',
    btnClear:         'üóë ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ Ÿàÿ•ÿπÿßÿØÿ© ÿßŸÑÿ∂ÿ®ÿ∑',
    dropTitle:        'ÿ£ÿ≥ŸÇÿ∑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ŸáŸÜÿß ÿ£Ÿà <span class="drop-link" onclick="document.getElementById(\'smartFileInput\').click()">ÿ™ÿµŸÅÿ≠</span>',
    dropSub:          'ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅŸä ÿßŸÑŸÅŸÜÿØŸÇ ŸàÿßŸÑŸÜÿ∏ÿßŸÖ ŸÖÿπÿßŸã ‚Äî Ÿäÿ™ÿπÿ±ŸÅ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿπŸÑŸâ ÿßŸÑŸÜŸàÿπ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã',
    dropFormats:      'PDF ¬∑ TXT ¬∑ CSV ¬∑ ÿØÿπŸÖ ŸÖŸÑŸÅÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ©',
    hotelCardLabel:   'ŸÖŸÑŸÅ/ŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÅŸÜÿØŸÇ',
    hotelCardTitle:   'üè® ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ŸÑŸÑŸÅŸÜÿØŸÇ',
    addHotelBtn:      'Ôºã ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑŸÅ ŸÅŸÜÿØŸÇ ŸäÿØŸàŸäÿßŸã',
    hotelPasteLabel:  'ÿ£Ÿà ÿßŸÑÿµŸÇ ŸÜÿµ ÿßŸÑŸÅŸÜÿØŸÇ',
    sysCardLabel:     'ŸÖŸÑŸÅ/ŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ',
    sysCardTitle:     'üñ• ŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ',
    addSysBtn:        'Ôºã ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÑŸÅ ŸÜÿ∏ÿßŸÖ ŸäÿØŸàŸäÿßŸã',
    sysPasteLabel:    'ÿ£Ÿà ÿßŸÑÿµŸÇ ŸÜÿµ ÿßŸÑŸÜÿ∏ÿßŸÖ',
    compareBtn:       '‚ö° ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖŸÇÿßÿ±ŸÜÿ©',
    ignorePanelTitle: 'ÿ™ÿ¨ÿßŸáŸÑ ÿßŸÑÿ™ÿπÿßÿ±ÿ∂',
    ignorePanelDesc:  'ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ≠ÿØÿØÿ© ÿ≥ÿ™Ÿèÿ™ÿ¨ÿßŸáŸÑ ‚Äî ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿ™Ÿèÿ≠ÿØŸéŸëÿ´ ŸÅŸàÿ±ÿßŸã',
    ignoreArrivalLbl: 'üìÖ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàÿµŸàŸÑ',
    ignoreGuestLbl:   'üë§ ÿßÿ≥ŸÖ ÿßŸÑÿ∂ŸäŸÅ',
    ignoreViewLbl:    'ü™ü ŸÜŸàÿπ ÿßŸÑÿ•ÿ∑ŸÑÿßŸÑÿ©',
    hotelPastePh:     'ÿßŸÑÿµŸÇ ŸÜÿµ ÿ≠ÿ¨Ÿàÿ≤ÿßÿ™ ÿßŸÑŸÅŸÜÿØŸÇ ŸáŸÜÿß...',
    sysPastePh:       'ÿßŸÑÿµŸÇ ŸÜÿµ ÿ≠ÿ¨Ÿàÿ≤ÿßÿ™ ÿßŸÑŸÜÿ∏ÿßŸÖ ŸáŸÜÿß...',
  }
};

function toggleLang() {
  currentLang = currentLang === 'en' ? 'ar' : 'en';
  const html = document.getElementById('appHtml');
  const t = TRANSLATIONS[currentLang];
  html.lang = currentLang;
  html.dir  = currentLang === 'ar' ? 'rtl' : 'ltr';

  // Update all labelled elements
  const set = (id, val, inner=true) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (inner) el.innerHTML = val;
    else el.textContent = val;
  };

  set('mainTitle',       t.mainTitle);
  set('mainSubtitle',    t.mainSubtitle,    false);
  set('themeBtn',        t.themeBtn,        false);
  set('langBtn',         t.langBtn,         false);
  set('btnClear',        t.btnClear,        false);
  set('dropTitle',       t.dropTitle);
  set('dropSub',         t.dropSub,         false);
  set('dropFormats',     t.dropFormats,     false);
  set('hotelCardLabel',  t.hotelCardLabel,  false);
  set('hotelCardTitle',  t.hotelCardTitle,  false);
  set('addHotelBtn',     t.addHotelBtn,     false);
  set('hotelPasteLabel', t.hotelPasteLabel, false);
  set('sysCardLabel',    t.sysCardLabel,    false);
  set('sysCardTitle',    t.sysCardTitle,    false);
  set('addSysBtn',       t.addSysBtn,       false);
  set('sysPasteLabel',   t.sysPasteLabel,   false);
  set('compareBtn',      t.compareBtn,      false);

  // Ignore panel
  const ipt = document.querySelector('.ignore-panel-title');
  if (ipt) ipt.textContent = t.ignorePanelTitle;
  const ipd = document.querySelector('.ignore-panel-desc');
  if (ipd) ipd.textContent = t.ignorePanelDesc;

  // Ignore checkbox labels
  document.querySelectorAll('.ignore-chk-label').forEach((el, i) => {
    el.textContent = [t.ignoreArrivalLbl, t.ignoreGuestLbl, t.ignoreViewLbl][i] || el.textContent;
  });

  // Textareas placeholders
  const hp = document.getElementById('hotelPaste');
  if (hp) hp.placeholder = t.hotelPastePh;
  const sp = document.getElementById('systemPaste');
  if (sp) sp.placeholder = t.sysPastePh;

  // File slot labels (dynamic slots)
  document.querySelectorAll('#hotelSlots .slot-label').forEach(el => {
    el.textContent = currentLang === 'ar' ? 'ŸÖŸÑŸÅ ÿßŸÑŸÅŸÜÿØŸÇ ‚Äî ÿßŸÜŸÇÿ± ÿ£Ÿà ÿßÿ≥ÿ≠ÿ® Ÿàÿ£ŸÅŸÑÿ™' : 'Hotel file ‚Äî click or drag & drop';
  });
  document.querySelectorAll('#systemSlots .slot-label').forEach(el => {
    el.textContent = currentLang === 'ar' ? 'ŸÖŸÑŸÅ ÿßŸÑŸÜÿ∏ÿßŸÖ ‚Äî ÿßŸÜŸÇÿ± ÿ£Ÿà ÿßÿ≥ÿ≠ÿ® Ÿàÿ£ŸÅŸÑÿ™' : 'System file ‚Äî click or drag & drop';
  });

  // Re-render results in new language if they exist
  if (currentResults.length) renderResults();
}
function togglePaste(type){const section=document.getElementById(type+'PasteSection');const btn=document.getElementById(type+'PasteToggle');section.classList.toggle('visible');btn.classList.toggle('open');}

window.addEventListener('load',()=>{addHotelSlot();addSystemSlot();initSmartDrop();});
</script>

<div class="powered-footer">
  <div class="pf-tag">‚ö° THIS APP IS POWERED BY</div>
  <div class="pf-name">MR. <span>HUSSIEN ALTANTAWY</span></div>
  <div class="pf-contacts" dir="ltr">
    <div class="pf-contact" dir="ltr">üì± <a href="tel:+201281806461" dir="ltr">+2 012 81 80 64 61</a></div>
    <div class="pf-contact" dir="ltr">üìß <a href="mailto:hussien.altantawy@yahoo.com" dir="ltr">HUSSIEN.ALTANTAWY@YAHOO.COM</a></div>
  </div>